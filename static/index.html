<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" href="/static/favicon.png?v=2">
<link rel="apple-touch-icon" href="/static/icon-192.png?v=2">
<title>GOATCOMMISH â€” Pickup Basketball</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800;900&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0d0d0f;
  --surface: #18181b;
  --surface2: #232328;
  --border: #2e2e35;
  --text: #f0f0f2;
  --text2: #9a9aab;
  --orange: #ff6a2f;
  --orange-glow: rgba(255,106,47,0.15);
  --green: #22c55e;
  --red: #ef4444;
  --grey: #71717a;
  --blue: #3b82f6;
}
* { box-sizing: border-box; margin:0; padding:0; }
body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }
h1,h2,h3,h4,h5 { font-family:'Outfit',sans-serif; }
::-webkit-scrollbar { width:6px; height:6px; }
::-webkit-scrollbar-track { background:var(--surface); }
::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
.glow-border { border:1px solid rgba(255,106,47,0.3); box-shadow:0 0 20px var(--orange-glow); }
.btn-primary { background:var(--orange); color:#fff; font-family:'Outfit',sans-serif; font-weight:600; padding:10px 24px; border:none; border-radius:8px; cursor:pointer; transition:all .2s; font-size:14px; }
.btn-primary:hover:not(:disabled) { background:#e85a20; transform:translateY(-1px); box-shadow:0 4px 15px var(--orange-glow); }
.btn-primary:disabled { opacity:0.5; cursor:not-allowed; }
.btn-secondary { background:var(--surface2); color:var(--text); font-family:'Outfit',sans-serif; font-weight:500; padding:10px 24px; border:1px solid var(--border); border-radius:8px; cursor:pointer; transition:all .2s; font-size:14px; }
.btn-secondary:hover { background:var(--border); }
.btn-danger { background:rgba(239,68,68,0.15); color:var(--red); font-family:'Outfit',sans-serif; font-weight:600; padding:10px 24px; border:1px solid rgba(239,68,68,0.3); border-radius:8px; cursor:pointer; transition:all .2s; font-size:14px; }
.btn-danger:hover { background:rgba(239,68,68,0.25); }
.btn-sm { padding:6px 14px; font-size:12px; }
input,select,textarea { background:var(--surface2); color:var(--text); border:1px solid var(--border); border-radius:8px; padding:10px 14px; font-family:'DM Sans',sans-serif; font-size:14px; width:100%; outline:none; transition:border .2s; }
input:focus,select:focus,textarea:focus { border-color:var(--orange); }
select { cursor:pointer; }
label { font-size:13px; color:var(--text2); font-weight:500; display:block; margin-bottom:4px; }
.card { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:20px; }
@keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
@keyframes slideIn { from{opacity:0;transform:translateX(-20px)} to{opacity:1;transform:translateX(0)} }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
@keyframes spin { to{transform:rotate(360deg)} }
.fade-in { animation:fadeIn .4s ease-out; }
.slide-in { animation:slideIn .3s ease-out; }
.toast { position:fixed; bottom:24px; right:24px; background:var(--surface2); border:1px solid var(--border); border-radius:12px; padding:14px 20px; z-index:1000; animation:fadeIn .3s ease-out; display:flex; align-items:center; gap:10px; font-size:14px; max-width:380px; }
.toast.success { border-color:rgba(34,197,94,0.4); }
.toast.error { border-color:rgba(239,68,68,0.4); }
.toast.info { border-color:rgba(59,130,246,0.4); }
nav { background:var(--surface); border-bottom:1px solid var(--border); padding:0 20px; position:sticky; top:0; z-index:100; }
nav .inner { max-width:1200px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; height:60px; }
nav .logo { font-family:'Outfit',sans-serif; font-weight:900; font-size:22px; color:var(--orange); display:flex; align-items:center; gap:8px; cursor:pointer; }
nav .logo span { color:var(--text); font-weight:600; font-size:14px; opacity:0.6; }
nav .nav-links { display:flex; gap:4px; align-items:center; }
nav .nav-links a { color:var(--text2); text-decoration:none; padding:8px 14px; border-radius:6px; font-size:13px; font-weight:500; transition:all .2s; cursor:pointer; }
nav .nav-links a:hover, nav .nav-links a.active { color:var(--text); background:var(--surface2); }
.hamburger { display:none; background:none; border:none; color:var(--text); cursor:pointer; font-size:24px; }
.mobile-menu { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:200; }
.mobile-menu.open { display:flex; }
.mobile-menu-content { background:var(--surface); width:280px; height:100%; padding:20px; animation:slideIn .3s ease-out; }
.mobile-menu a { display:block; color:var(--text2); text-decoration:none; padding:12px 14px; border-radius:8px; font-size:15px; margin-bottom:4px; }
.mobile-menu a:hover, .mobile-menu a.active { color:var(--text); background:var(--surface2); }
.games-grid { display:flex; gap:16px; overflow-x:auto; padding:20px 0; min-height:400px; }
.game-col { min-width:240px; max-width:280px; flex-shrink:0; background:var(--surface); border:1px solid var(--border); border-radius:16px; overflow:hidden; }
.game-header { padding:16px; border-bottom:1px solid var(--border); text-align:center; }
.game-header .weekday { font-family:'Outfit',sans-serif; font-weight:800; font-size:18px; text-transform:uppercase; letter-spacing:1px; }
.game-header .date { font-size:13px; color:var(--text2); margin-top:2px; }
.game-header .time-loc { font-size:12px; color:var(--text2); margin-top:6px; }
.game-header .cap { font-size:11px; color:var(--grey); margin-top:4px; }
.game-action { padding:12px 16px; border-bottom:1px solid var(--border); }
.game-players { padding:8px; max-height:500px; overflow-y:auto; }
.player-slot { padding:8px 12px; border-radius:6px; font-size:13px; margin:2px 0; display:flex; align-items:center; gap:8px; }
.player-slot.in-game { color:var(--green); }
.player-slot.waitlist { color:var(--red); }
.player-slot.pending { color:var(--grey); }
.player-slot .num { font-weight:600; font-size:11px; min-width:20px; }
.empty-slot { border:1px dashed var(--border); padding:8px 12px; border-radius:6px; margin:2px 0; height:36px; }
.waitlist-divider { font-size:10px; color:var(--red); text-transform:uppercase; letter-spacing:1px; padding:8px 12px; font-weight:600; opacity:0.7; }
.data-table { width:100%; border-collapse:collapse; }
.data-table th { text-align:left; padding:10px 14px; font-size:12px; color:var(--text2); text-transform:uppercase; letter-spacing:0.5px; border-bottom:1px solid var(--border); font-weight:500; }
.data-table td { padding:10px 14px; font-size:14px; border-bottom:1px solid var(--border); }
.data-table tr:hover td { background:var(--surface2); }
.badge { display:inline-block; padding:2px 8px; border-radius:4px; font-size:11px; font-weight:600; }
.badge-green { background:rgba(34,197,94,0.15); color:var(--green); }
.badge-red { background:rgba(239,68,68,0.15); color:var(--red); }
.badge-orange { background:var(--orange-glow); color:var(--orange); }
.badge-blue { background:rgba(59,130,246,0.15); color:var(--blue); }
.badge-grey { background:rgba(113,113,122,0.15); color:var(--grey); }
.alert-bar { background:rgba(255,106,47,0.1); border:1px solid rgba(255,106,47,0.3); border-radius:10px; padding:12px 16px; display:flex; align-items:center; gap:10px; margin-bottom:16px; font-size:13px; }
.tabs { display:flex; gap:2px; background:var(--surface2); border-radius:8px; padding:2px; margin-bottom:20px; }
.tab { padding:8px 16px; border-radius:6px; font-size:13px; font-weight:500; cursor:pointer; color:var(--text2); transition:all .2s; flex:1; text-align:center; }
.tab.active { background:var(--surface); color:var(--text); }
.toggle { position:relative; width:44px; height:24px; cursor:pointer; }
.toggle input { opacity:0; width:0; height:0; }
.toggle .slider { position:absolute; inset:0; background:var(--surface2); border:1px solid var(--border); border-radius:12px; transition:.3s; }
.toggle .slider:before { content:''; position:absolute; height:18px; width:18px; left:2px; bottom:2px; background:var(--text2); border-radius:50%; transition:.3s; }
.toggle input:checked + .slider { background:var(--orange); border-color:var(--orange); }
.toggle input:checked + .slider:before { transform:translateX(20px); background:#fff; }
.spinner { display:inline-block; width:18px; height:18px; border:2px solid var(--border); border-top-color:var(--orange); border-radius:50%; animation:spin .6s linear infinite; }
.loading-overlay { display:flex; align-items:center; justify-content:center; padding:60px; }
@media (max-width:768px) {
  .nav-links { display:none !important; }
  .hamburger { display:block !important; }
  .games-grid { padding:12px 0; }
  .game-col { min-width:220px; }
}
</style>
</head>
<body>
<div id="app"></div>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API CLIENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API_BASE = window.location.origin + '/api';

function getToken() { return localStorage.getItem('hoops_token'); }
function setToken(t) { localStorage.setItem('hoops_token', t); }
function clearToken() { localStorage.removeItem('hoops_token'); localStorage.removeItem('hoops_user'); }
function getStoredUser() { try { return JSON.parse(localStorage.getItem('hoops_user')); } catch { return null; } }
function setStoredUser(u) { localStorage.setItem('hoops_user', JSON.stringify(u)); }

async function api(path, opts = {}) {
  const headers = { 'Content-Type': 'application/json', ...opts.headers };
  const token = getToken();
  if (token) headers['Authorization'] = `Bearer ${token}`;
  const res = await fetch(API_BASE + path, { ...opts, headers });
  if (res.status === 401) {
    clearToken();
    currentUser = null;
    currentPage = 'login';
    render();
    throw new Error('Session expired');
  }
  const data = await res.json();
  if (!res.ok) {
    // FastAPI returns {detail: string} for HTTPException
    // and {detail: [{msg, loc, type},...]} for validation errors (422)
    let msg = `Error ${res.status}`;
    if (typeof data.detail === 'string') {
      msg = data.detail;
    } else if (Array.isArray(data.detail) && data.detail.length > 0) {
      msg = data.detail.map(e => `${e.loc?.slice(-1)?.[0] || 'field'}: ${e.msg}`).join(', ');
    }
    throw new Error(msg);
  }
  return data;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

let currentUser = getStoredUser();
let currentPage = currentUser ? 'games' : 'login';
let mobileMenuOpen = false;
let loading = false;

// Cached data from API
let cachedGames = [];
let cachedPlayers = [];
let cachedSettings = null;
let cachedLocations = [];
let cachedPendingCount = 0;

let mgmtTab = 'pending';
let gameRefreshTimer = null;
let ownerViewMode = true;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function isOwner() { return currentUser && currentUser.role === 'owner'; }
function formatDate(iso) { const d = new Date(iso); return `${MONTHS[d.getMonth()]} ${d.getDate()}`; }
function formatTime(iso) { const d = new Date(iso); let h=d.getHours(),m=d.getMinutes(); const ap=h>=12?'PM':'AM'; h=h%12||12; return `${h}:${m.toString().padStart(2,'0')} ${ap}`; }
function formatWeekday(iso) { return DAYS[new Date(iso).getDay()]; }
function isGameStarted(game) { return new Date(game.date).getTime() < Date.now(); }
function esc(s) { const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

function showToast(msg, type='info') {
  document.querySelectorAll('.toast').forEach(t=>t.remove());
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  const icons = {success:'âœ“',error:'âœ•',info:'â„¹'};
  t.innerHTML = `<span style="font-size:18px">${icons[type]||'â„¹'}</span> ${esc(msg)}`;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(), 3500);
}

function setLoading(v) { loading = v; }

function renderSpinner() {
  return `<div class="loading-overlay"><div class="spinner"></div></div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA FETCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchGames() {
  try { cachedGames = await api('/games'); } catch(e) { console.error('fetchGames:', e); }
}

async function fetchPlayers() {
  if (!isOwner()) return;
  try { cachedPlayers = await api('/admin/players'); } catch(e) { console.error('fetchPlayers:', e); }
}

async function fetchPendingCount() {
  if (!isOwner()) return;
  try { const r = await api('/admin/players/pending-count'); cachedPendingCount = r.count; } catch { cachedPendingCount = 0; }
}

async function fetchSettings() {
  if (!isOwner()) return;
  try { cachedSettings = await api('/settings'); cachedLocations = cachedSettings.locations; } catch(e) { console.error('fetchSettings:', e); }
}

async function fetchLocations() {
  try { cachedLocations = await api('/settings/locations'); } catch { cachedLocations = []; }
}

async function loadPageData() {
  if (!currentUser) return;
  const promises = [fetchGames()];
  if (isOwner()) promises.push(fetchPendingCount());
  if (currentPage === 'player_mgmt') promises.push(fetchPlayers());
  if (currentPage === 'owner_settings') promises.push(fetchSettings());
  if (currentPage === 'create_game') promises.push(fetchLocations(), fetchPlayers());
  await Promise.all(promises);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render() {
  const app = document.getElementById('app');
  if (currentPage === 'login') { app.innerHTML = renderLogin(); return; }
  if (currentPage === 'signup') { app.innerHTML = renderNewSignup(); return; }
  if (currentPage === 'reset_password') { app.innerHTML = renderResetPassword(); return; }
  if (currentPage === 'force_change_pw') { app.innerHTML = renderForceChangePassword(); return; }

  let nav = renderNav();
  let content = '';
  switch(currentPage) {
    case 'games': content = renderGames(); break;
    case 'create_game': content = renderCreateGame(); break;
    case 'player_settings': content = renderPlayerSettings(); break;
    case 'owner_settings': content = renderOwnerSettings(); break;
    case 'player_mgmt': content = renderPlayerMgmt(); break;
    default: content = renderGames();
  }
  app.innerHTML = nav + `<main style="max-width:1200px;margin:0 auto;padding:20px;">${content}</main>`;
  bindEvents();
}

// â”€â”€ Countdown Ticker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// (handled by updateCountdowns in bindEvents)

function renderNav() {
  const pc = cachedPendingCount;
  const pendingBadge = isOwner()&&pc>0 ? `<span style="background:var(--red);color:#fff;border-radius:50%;padding:1px 6px;font-size:10px;font-weight:700;margin-left:4px;">${pc}</span>` : '';
  return `<nav><div class="inner">
    <div class="logo" onclick="navigate('games')"><img src="/static/icon-40.png?v=2" style="width:32px;height:32px;vertical-align:middle;"> GOATCOMMISH</div>
    <div class="nav-links">
      <a onclick="navigate('games')" class="${currentPage==='games'?'active':''}">Games</a>
      ${isOwner()?`<a onclick="navigate('create_game')" class="${currentPage==='create_game'?'active':''}">Create Game</a>`:''}
      ${isOwner()?`<a onclick="navigate('player_mgmt')" class="${currentPage==='player_mgmt'?'active':''}">Players${pendingBadge}</a>`:''}
      <a onclick="navigate('player_settings')" class="${currentPage==='player_settings'?'active':''}">Settings</a>
      ${isOwner()?`<a onclick="navigate('owner_settings')" class="${currentPage==='owner_settings'?'active':''}">Admin</a>`:''}
      <a onclick="doLogout()" style="color:var(--red)">Logout</a>
    </div>
    <button class="hamburger" onclick="toggleMobileMenu()">â˜°</button>
  </div></nav>
  <div class="mobile-menu ${mobileMenuOpen?'open':''}" onclick="closeMobileMenu(event)">
    <div class="mobile-menu-content">
      <div class="logo" style="margin-bottom:20px;font-size:20px" onclick="navigate('games');mobileMenuOpen=false;"><img src="/static/icon-40.png?v=2" style="width:28px;height:28px;vertical-align:middle;"> GOATCOMMISH</div>
      <a onclick="navigate('games');mobileMenuOpen=false;" class="${currentPage==='games'?'active':''}">ğŸ® Games</a>
      ${isOwner()?`<a onclick="navigate('create_game');mobileMenuOpen=false;" class="${currentPage==='create_game'?'active':''}">â• Create Game</a>`:''}
      ${isOwner()?`<a onclick="navigate('player_mgmt');mobileMenuOpen=false;" class="${currentPage==='player_mgmt'?'active':''}">ğŸ‘¥ Players${pendingBadge}</a>`:''}
      <a onclick="navigate('player_settings');mobileMenuOpen=false;" class="${currentPage==='player_settings'?'active':''}">âš™ Settings</a>
      ${isOwner()?`<a onclick="navigate('owner_settings');mobileMenuOpen=false;" class="${currentPage==='owner_settings'?'active':''}">ğŸ”§ Admin</a>`:''}
      <a onclick="doLogout()" style="color:var(--red)">ğŸšª Logout</a>
    </div>
  </div>`;
}

// â•â•â• LOGIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderLogin() {
  return `<div style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;">
    <div class="card glow-border fade-in" style="max-width:400px;width:100%;text-align:center;">
      <img src="/static/logo.png?v=2" style="width:200px;margin:0 auto 16px;display:block;">
      <p style="color:var(--text2);font-size:14px;margin-bottom:28px;">Pickup Basketball</p>
      <div style="text-align:left;">
        <label>Email</label>
        <input type="email" id="login-email" placeholder="you@example.com" style="margin-bottom:12px;">
        <label>Password</label>
        <input type="password" id="login-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" style="margin-bottom:20px;"
          onkeydown="if(event.key==='Enter')doLogin()">
        <button class="btn-primary" id="login-btn" style="width:100%;padding:12px;" onclick="doLogin()">Sign In</button>
      </div>
      <div style="margin-top:20px;display:flex;justify-content:center;gap:16px;font-size:13px;">
        <a style="color:var(--orange);cursor:pointer;" onclick="navigate('signup')">New player? Sign up</a>
        <a style="color:var(--text2);cursor:pointer;" onclick="doResetPassword()">Forgot password?</a>
      </div>
    </div>
  </div>`;
}

async function doLogin() {
  const email = document.getElementById('login-email').value.trim();
  const pass = document.getElementById('login-pass').value;
  if (!email || !pass) { showToast('Enter email and password','error'); return; }
  const btn = document.getElementById('login-btn');
  btn.disabled = true; btn.innerHTML = '<span class="spinner"></span>';
  try {
    const data = await api('/auth/login', { method:'POST', body:JSON.stringify({email,password:pass}) });
    setToken(data.access_token);
    currentUser = data.player;
    setStoredUser(currentUser);

    if (currentUser.force_password_change) {
      currentPage = 'force_change_pw';
      render();
      return;
    }

    currentPage = 'games';
    await loadPageData();
    render();
    if (isOwner() && cachedPendingCount > 0) showToast(`${cachedPendingCount} player(s) awaiting approval`,'info');
    startGameRefresh();
  } catch(e) {
    showToast(e.message,'error');
    btn.disabled = false; btn.textContent = 'Sign In';
  }
}

async function doResetPassword() {
  const email = document.getElementById('login-email').value.trim();
  if (!email) { showToast('Enter your email first','error'); return; }
  try { await api(`/auth/reset-password?email=${encodeURIComponent(email)}`, {method:'POST'}); showToast('Reset link sent if account exists','success'); } catch(e) { showToast(e.message,'error'); }
}

function renderResetPassword() {
  return `<div style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;">
    <div class="card glow-border fade-in" style="max-width:400px;width:100%;text-align:center;">
      <div style="font-size:48px;margin-bottom:8px;">ğŸ”‘</div>
      <h2 style="font-size:24px;font-weight:800;margin-bottom:4px;">Reset Password</h2>
      <p style="color:var(--text2);font-size:13px;margin-bottom:24px;">Enter your new password below.</p>
      <div style="text-align:left;">
        <label>New Password</label>
        <input type="password" id="reset-pass" placeholder="New password" style="margin-bottom:12px;">
        <label>Confirm Password</label>
        <input type="password" id="reset-pass2" placeholder="Confirm password" style="margin-bottom:20px;"
          onkeydown="if(event.key==='Enter')doConfirmReset()">
        <button class="btn-primary" id="reset-btn" style="width:100%;padding:12px;" onclick="doConfirmReset()">Set New Password</button>
      </div>
      <p style="margin-top:16px;font-size:13px;"><a style="color:var(--orange);cursor:pointer;" onclick="window.history.replaceState({},'','/');navigate('login')">â† Back to login</a></p>
    </div>
  </div>`;
}

async function doConfirmReset() {
  const pass = document.getElementById('reset-pass').value;
  const pass2 = document.getElementById('reset-pass2').value;
  if (!pass || pass.length < 4) { showToast('Password must be at least 4 characters','error'); return; }
  if (pass !== pass2) { showToast('Passwords do not match','error'); return; }
  const btn = document.getElementById('reset-btn');
  btn.disabled = true; btn.innerHTML = '<span class="spinner"></span>';
  try {
    const token = window._resetToken;
    const r = await api(`/auth/reset-password/confirm?token=${encodeURIComponent(token)}&new_password=${encodeURIComponent(pass)}`, {method:'POST'});
    showToast(r.message, 'success');
    window.history.replaceState({}, '', '/');
    setTimeout(() => navigate('login'), 1500);
  } catch(e) { showToast(e.message, 'error'); btn.disabled = false; btn.textContent = 'Set New Password'; }
}

// â•â•â• FORCED PASSWORD CHANGE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderForceChangePassword() {
  return `<div style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;">
    <div class="card glow-border fade-in" style="max-width:400px;width:100%;text-align:center;">
      <div style="font-size:48px;margin-bottom:8px;">ğŸ”</div>
      <h2 style="font-size:24px;font-weight:800;margin-bottom:4px;">Change Your Password</h2>
      <p style="color:var(--text2);font-size:13px;margin-bottom:24px;">Your account was created with a temporary password. Please set a new one to continue.</p>
      <div style="text-align:left;">
        <label>New Password</label>
        <input type="password" id="fcp-pass" placeholder="Choose a new password" style="margin-bottom:12px;">
        <label>Confirm Password</label>
        <input type="password" id="fcp-pass2" placeholder="Confirm new password" style="margin-bottom:20px;"
          onkeydown="if(event.key==='Enter')doForceChangePassword()">
        <button class="btn-primary" id="fcp-btn" style="width:100%;padding:12px;" onclick="doForceChangePassword()">Set Password &amp; Continue</button>
      </div>
    </div>
  </div>`;
}

async function doForceChangePassword() {
  const pass = document.getElementById('fcp-pass').value;
  const pass2 = document.getElementById('fcp-pass2').value;
  if (!pass || pass.length < 4) { showToast('Password must be at least 4 characters','error'); return; }
  if (pass !== pass2) { showToast('Passwords do not match','error'); return; }
  if (pass === currentUser.email) { showToast('Password cannot be your email address','error'); return; }
  const btn = document.getElementById('fcp-btn');
  btn.disabled = true; btn.innerHTML = '<span class="spinner"></span>';
  try {
    const updated = await api('/players/me', { method:'PATCH', body:JSON.stringify({password:pass}) });
    currentUser = updated;
    setStoredUser(currentUser);
    showToast('Password updated!','success');
    currentPage = 'games';
    await loadPageData();
    render();
    startGameRefresh();
  } catch(e) { showToast(e.message,'error'); btn.disabled=false; btn.textContent='Set Password & Continue'; }
}

// â•â•â• NEW PLAYER SIGNUP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderNewSignup() {
  return `<div style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;">
    <div class="card glow-border fade-in" style="max-width:420px;width:100%;text-align:center;">
      <h2 style="font-size:24px;font-weight:800;margin-bottom:4px;">Join the Run</h2>
      <p style="color:var(--text2);font-size:13px;margin-bottom:24px;">Sign up to play pickup basketball. An admin will approve your account.</p>
      <div style="text-align:left;">
        <label>Full Name</label><input id="su-name" placeholder="Your name" style="margin-bottom:12px;">
        <label>Email</label><input type="email" id="su-email" placeholder="you@example.com" style="margin-bottom:12px;">
        <label>Mobile Phone</label><input type="tel" id="su-mobile" placeholder="555-0123" style="margin-bottom:12px;">
        <label>Password</label><input type="password" id="su-pass" placeholder="Choose a password" style="margin-bottom:12px;">
        <label>Notification Preference</label>
        <select id="su-notif" style="margin-bottom:20px;">
          <option value="email">Email</option><option value="sms">SMS</option><option value="push">Push Notification</option>
        </select>
        <button class="btn-primary" id="su-btn" style="width:100%;padding:12px;" onclick="doSignup()">Request to Join</button>
      </div>
      <p style="margin-top:16px;font-size:13px;"><a style="color:var(--orange);cursor:pointer;" onclick="navigate('login')">â† Back to login</a></p>
    </div>
  </div>`;
}

async function doSignup() {
  const name=document.getElementById('su-name').value.trim(), email=document.getElementById('su-email').value.trim();
  const mobile=document.getElementById('su-mobile').value.trim(), pass=document.getElementById('su-pass').value;
  const notif=document.getElementById('su-notif').value;
  if(!name||!email||!pass) { showToast('Fill in all required fields','error'); return; }
  const btn=document.getElementById('su-btn'); btn.disabled=true; btn.innerHTML='<span class="spinner"></span>';
  try {
    await api('/auth/register', { method:'POST', body:JSON.stringify({name,email,mobile,password:pass,notif_pref:notif}) });
    showToast('Sign up submitted! An admin will review.','success');
    setTimeout(()=>navigate('login'), 1500);
  } catch(e) { showToast(e.message,'error'); btn.disabled=false; btn.textContent='Request to Join'; }
}

// â•â•â• GAMES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderGames() {
  if (loading) return renderSpinner();
  const games = cachedGames.sort((a,b)=>new Date(a.date)-new Date(b.date));
  if (!games.length) return `<div class="fade-in" style="text-align:center;padding:60px 20px;">
    <div style="font-size:64px;margin-bottom:16px;"><img src="/static/icon-192.png?v=2" style="width:80px;height:80px;"></div>
    <h2 style="font-weight:700;margin-bottom:8px;">No Games Available</h2>
    <p style="color:var(--text2);font-size:14px;">Check back later or ask an admin to create a game.</p></div>`;

  const viewToggle = isOwner() ? `<div style="display:flex;align-items:center;gap:8px;">
    <span style="font-size:12px;color:${ownerViewMode?'var(--text2)':'var(--orange)'};cursor:pointer;" onclick="ownerViewMode=false;render()">Player</span>
    <label class="toggle" style="margin:0;"><input type="checkbox" ${ownerViewMode?'checked':''} onchange="ownerViewMode=this.checked;render()"><span class="slider"></span></label>
    <span style="font-size:12px;color:${ownerViewMode?'var(--orange)':'var(--text2)'};cursor:pointer;" onclick="ownerViewMode=true;render()">Owner</span>
  </div>` : '';

  return `<div class="fade-in">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
      <h2 style="font-weight:800;font-size:24px;">Upcoming Games</h2>
      <div style="display:flex;align-items:center;gap:12px;">
        ${viewToggle}
        <span style="color:var(--text2);font-size:13px;">${games.length} game${games.length!==1?'s':''}</span>
      </div>
    </div>
    <div class="games-grid">${games.map(g=>renderGameColumn(g)).join('')}</div></div>`;
}

function renderGameColumn(game) {
  const started = isGameStarted(game);
  const isSignedUp = game.signups.find(s=>s.player_id===currentUser.id);
  const cap = game.cap_enabled ? game.cap : 'âˆ';
  const inGame = game.signups.filter(s=>s.status==='in');
  const waitlist = game.signups.filter(s=>s.status==='waitlist');
  const spotsLeft = game.cap_enabled ? Math.max(0, game.cap - inGame.length) : null;

  let actionBtn = '';
  if (!started && !game.closed) {
    if (isSignedUp) actionBtn = `<button class="btn-danger" style="width:100%;font-size:13px;padding:8px;" onclick="takeOff(${game.id})">âœ• Take Me Off</button>`;
    else actionBtn = `<button class="btn-primary" style="width:100%;font-size:13px;padding:8px;" onclick="addMe(${game.id})">+ Add Me</button>`;
  } else if (started) actionBtn = `<span style="color:var(--text2);font-size:12px;">Game started</span>`;

  let statusBadge = '';
  if (game.algorithm==='random' && !game.selection_done)
    statusBadge = `<div style="margin-top:6px;"><span class="badge badge-orange" style="animation:pulse 2s infinite;">â³ Selection pending</span></div>`; else if (spotsLeft!==null && spotsLeft>0)
    statusBadge = `<div style="margin-top:6px;"><span class="badge badge-green">${spotsLeft} spot${spotsLeft!==1?'s':''} open</span></div>`;
  else if (spotsLeft===0)
    statusBadge = `<div style="margin-top:6px;"><span class="badge badge-red">Full</span></div>`;

  let playerList = '';
  if (game.selection_done || game.algorithm==='first_come') {
    inGame.forEach((s,i)=> { playerList += `<div class="player-slot in-game"><span class="num">${i+1}</span> ${esc(s.player_name)}</div>`; });
    if (spotsLeft!==null) for(let i=0;i<spotsLeft;i++) playerList += `<div class="empty-slot"></div>`;
    if (waitlist.length>0) {
      playerList += `<div class="waitlist-divider">â€” Waitlist â€”</div>`;
      waitlist.forEach((s,i)=> { playerList += `<div class="player-slot waitlist"><span class="num">W${i+1}</span> ${esc(s.player_name)}</div>`; });
    }
  } else {
    const all = [...game.signups].sort((a,b)=>new Date(a.signed_up_at)-new Date(b.signed_up_at));
    all.forEach((s,i)=> { playerList += `<div class="player-slot pending"><span class="num">${i+1}</span> ${esc(s.player_name)}</div>`; });
  }

  const algLabel = {first_come:'First Come',random:'Random',weighted:'Weighted'}[game.algorithm]||game.algorithm;
  let ownerCtrl = '';
  if (isOwner() && ownerViewMode && !started && !game.closed) {
    let cascadeStatus = '';
    if (game.notified_at) {
      // Build detailed cascade timeline
      let steps = [];

      // High priority
      steps.push(`<div style="display:flex;align-items:center;gap:6px;"><span style="color:var(--green);">âœ…</span> <span>High priority notified</span></div>`);

      // Standard priority
      if (game.notify_standard_status === 'completed') {
        steps.push(`<div style="display:flex;align-items:center;gap:6px;"><span style="color:var(--green);">âœ…</span> <span>Standard priority notified</span></div>`);
      } else if (game.notify_standard_at) {
        steps.push(`<div style="display:flex;align-items:center;gap:6px;"><span>â³</span> <span>Standard priority <span id="cd-std-${game.id}" data-target="${game.notify_standard_at}" class="cascade-cd"></span></span></div>`);
      }

      // Selection (random only)
      if (game.algorithm === 'random') {
        if (game.selection_done) {
          steps.push(`<div style="display:flex;align-items:center;gap:6px;"><span style="color:var(--green);">âœ…</span> <span>Players selected</span></div>`);
        } else if (game.auto_selection_at) {
          steps.push(`<div style="display:flex;align-items:center;gap:6px;"><span>ğŸ²</span> <span>Auto-select <span id="cd-sel-${game.id}" data-target="${game.auto_selection_at}" class="cascade-cd"></span></span></div>`);
        }
      }

      // Low priority
      if (game.notify_low_status === 'completed') {
        steps.push(`<div style="display:flex;align-items:center;gap:6px;"><span style="color:var(--green);">âœ…</span> <span>Low priority notified</span></div>`);
      } else if (game.notify_low_at) {
        steps.push(`<div style="display:flex;align-items:center;gap:6px;"><span>â³</span> <span>Low priority <span id="cd-low-${game.id}" data-target="${game.notify_low_at}" class="cascade-cd"></span></span></div>`);
      }

      if (steps.length > 0) {
        cascadeStatus = `<div style="padding:4px 16px 8px;font-size:11px;color:var(--text2);display:grid;gap:3px;">${steps.join('')}</div>`;
      }
    }

    ownerCtrl = `${cascadeStatus}<div style="padding:4px 16px 8px;display:flex;gap:4px;">
      ${game.algorithm==='random'&&!game.selection_done ? `<button class="btn-primary btn-sm" style="flex:1;font-size:11px;" onclick="runSelection(${game.id})">âš¡ Set Now</button>` : ''}
      <button class="btn-danger btn-sm" style="font-size:11px;" onclick="cancelGame(${game.id})">Cancel</button></div>`;
  }

  return `<div class="game-col slide-in">
    <div class="game-header">
      <div class="weekday">${formatWeekday(game.date)}</div>
      <div class="date">${formatDate(game.date)}</div>
      <div class="time-loc">${formatTime(game.date)} Â· ${esc(game.location)}</div>
      <div class="cap">Max: ${cap} Â· ${algLabel}</div>${statusBadge}
    </div>
    <div class="game-action">${actionBtn}</div>${ownerCtrl}
    <div class="game-players">${playerList || '<div style="text-align:center;padding:20px;color:var(--text2);font-size:13px;">No signups yet</div>'}</div>
  </div>`;
}

// â•â•â• GAME ACTIONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function addMe(gameId) {
  try {
    const r = await api(`/games/${gameId}/signup`, {method:'POST'});
    showToast(r.message, r.status==='in'?'success':'info');
    await fetchGames(); render();
  } catch(e) { showToast(e.message,'error'); }
}

async function takeOff(gameId) {
  try {
    const r = await api(`/games/${gameId}/drop`, {method:'POST'});
    showToast(r.message,'success');
    if (r.promoted) showToast(`${r.promoted} promoted from waitlist`,'info');
    await fetchGames(); render();
  } catch(e) { showToast(e.message,'error'); }
}

async function runSelection(gameId) {
  try {
    const r = await api(`/games/${gameId}/run-selection`, {method:'POST'});
    showToast(`Selection done: ${r.in_count} in, ${r.waitlist_count} waitlisted`,'success');
    await fetchGames(); render();
  } catch(e) { showToast(e.message,'error'); }
}

async function cancelGame(gameId) {
  const game = cachedGames.find(g => g.id === gameId);
  const signupCount = game ? game.signups.length : 0;
  const msg = signupCount > 0
    ? `Cancel this game? ${signupCount} signed-up player${signupCount!==1?'s':''} will be notified.`
    : 'Cancel this game?';
  if (!confirm(msg)) return;
  try { await api(`/games/${gameId}/close`, {method:'POST'}); showToast('Game cancelled â€” players notified','success'); await fetchGames(); render(); }
  catch(e) { showToast(e.message,'error'); }
}

// â•â•â• CREATE GAME â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCreateGame() {
  if (!isOwner()) return '<p>Access denied.</p>';
  const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate()+1);
  tomorrow.setHours(18,0,0,0);
  // datetime-local needs YYYY-MM-DDTHH:MM format
  const pad = n => String(n).padStart(2,'0');
  const defaultDT = `${tomorrow.getFullYear()}-${pad(tomorrow.getMonth()+1)}-${pad(tomorrow.getDate())}T${pad(tomorrow.getHours())}:${pad(tomorrow.getMinutes())}`;
  const defaultNotifyDT = `${tomorrow.getFullYear()}-${pad(tomorrow.getMonth()+1)}-${pad(tomorrow.getDate())}T12:00`;
  const defAlg = cachedSettings?.default_algorithm || 'first_come';
  const defCap = cachedSettings?.default_cap || 12;
  const defCapOn = cachedSettings?.cap_enabled !== false;

  const locOptions = cachedLocations.map(l=>`<option value="${esc(l)}">${esc(l)}</option>`).join('');
  const approvedPlayers = cachedPlayers.filter(p=>p.status==='approved');
  const playerCheckboxes = approvedPlayers.map(p=>
    `<label style="display:flex;align-items:center;gap:8px;padding:6px 0;cursor:pointer;"><input type="checkbox" class="owner-add-player" value="${p.id}" style="width:auto;"> ${esc(p.name)}</label>`
  ).join('');

  return `<div class="fade-in" style="max-width:600px;">
    <h2 style="font-weight:800;font-size:24px;margin-bottom:20px;">Create Game</h2>
    <div class="card"><div style="display:grid;gap:16px;">
      <div><label>Game Date &amp; Time</label><input type="datetime-local" id="cg-datetime" value="${defaultDT}"></div>
      <div><label>Location</label><select id="cg-location" onchange="toggleOtherLoc()">${locOptions}<option value="other">Other...</option></select>
        <input type="text" id="cg-other-loc" placeholder="Enter location details" style="display:none;margin-top:8px;"></div>
      <div><label>Algorithm</label><select id="cg-algorithm">
        <option value="first_come" ${defAlg==='first_come'?'selected':''}>First Come, First Served</option>
        <option value="random" ${defAlg==='random'?'selected':''}>Random Selection</option></select></div>
      <div style="display:flex;align-items:center;gap:12px;">
        <label class="toggle" style="margin-bottom:0;"><input type="checkbox" id="cg-cap-on" ${defCapOn?'checked':''} onchange="toggleCapInput()"><span class="slider"></span></label>
        <span style="font-size:14px;">Player Cap</span>
        <input type="number" id="cg-cap" value="${defCap}" min="2" max="100" style="width:80px;${defCapOn?'':'opacity:0.4'}"></div>
      <div><label>Add Players to Game</label><div class="card" style="max-height:200px;overflow-y:auto;padding:8px 14px;">${playerCheckboxes||'<span style="color:var(--text2);font-size:13px;">No players loaded</span>'}</div></div>
      <div style="display:flex;align-items:center;gap:12px;">
        <label class="toggle" style="margin-bottom:0;"><input type="checkbox" id="cg-delay-notif"><span class="slider"></span></label>
        <span style="font-size:14px;">Notify at future time</span></div>
      <div id="cg-delay-fields" style="display:none;">
        <label>Notification Date &amp; Time</label><input type="datetime-local" id="cg-notify-datetime" value="${defaultNotifyDT}"></div>
      <button class="btn-primary" id="cg-btn" style="width:100%;padding:12px;margin-top:8px;" onclick="createGame()">Create Game</button>
    </div></div></div>`;
}

function toggleOtherLoc() { const s=document.getElementById('cg-location'), o=document.getElementById('cg-other-loc'); o.style.display=s.value==='other'?'block':'none'; }
function toggleCapInput() { const on=document.getElementById('cg-cap-on').checked; document.getElementById('cg-cap').style.opacity=on?'1':'0.4'; }

async function createGame() {
  const dt = document.getElementById('cg-datetime').value;
  if(!dt) { showToast('Set a date and time','error'); return; }
  // Normalize: datetime-local gives "YYYY-MM-DDTHH:MM", we need "YYYY-MM-DDTHH:MM:SS"
  const gameDate = dt.includes(':') && dt.length === 16 ? dt + ':00' : dt;
  // Validate it parses
  if (isNaN(new Date(gameDate).getTime())) { showToast('Invalid date/time â€” please re-select','error'); return; }

  let location = document.getElementById('cg-location').value;
  if(location==='other') location = document.getElementById('cg-other-loc').value || 'TBD';
  const algorithm = document.getElementById('cg-algorithm').value;
  const capEnabled = document.getElementById('cg-cap-on').checked;
  const cap = parseInt(document.getElementById('cg-cap').value)||12;
  const ownerAdded = [...document.querySelectorAll('.owner-add-player:checked')].map(cb=>parseInt(cb.value)).filter(n=>!isNaN(n));
  let notify_future_at = null;
  if (document.getElementById('cg-delay-notif').checked) {
    const ndt = document.getElementById('cg-notify-datetime').value;
    if(ndt) notify_future_at = ndt.length === 16 ? ndt + ':00' : ndt;
  }
  const btn=document.getElementById('cg-btn'); btn.disabled=true; btn.innerHTML='<span class="spinner"></span>';
  try {
    await api('/games', { method:'POST', body:JSON.stringify({
      date:gameDate, location, algorithm, cap, cap_enabled:capEnabled,
      owner_added_player_ids:ownerAdded, notify_future_at
    })});
    showToast('Game created! ğŸ‰','success');
    await fetchGames(); navigate('games');
  } catch(e) { showToast(e.message,'error'); btn.disabled=false; btn.textContent='Create Game'; }
}

// â•â•â• PLAYER SETTINGS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPlayerSettings() {
  const u = currentUser;
  return `<div class="fade-in" style="max-width:500px;">
    <h2 style="font-weight:800;font-size:24px;margin-bottom:20px;">My Settings</h2>
    <div class="card"><div style="display:grid;gap:16px;">
      <div><label>Name</label><input id="ps-name" value="${esc(u.name)}"></div>
      <div><label>Email</label><input type="email" id="ps-email" value="${esc(u.email)}"></div>
      <div><label>Mobile</label><input type="tel" id="ps-mobile" value="${esc(u.mobile||'')}"></div>
      <div><label>New Password (leave blank to keep current)</label><input type="password" id="ps-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"></div>
      <div><label>Notification Preference</label><select id="ps-notif">
        <option value="email" ${u.notif_pref==='email'?'selected':''}>Email</option>
        <option value="sms" ${u.notif_pref==='sms'?'selected':''}>SMS / Text</option>
        <option value="push" ${u.notif_pref==='push'?'selected':''}>Push Notification</option></select></div>
      <button class="btn-primary" onclick="savePlayerSettings()">Save Changes</button>
    </div></div></div>`;
}

async function savePlayerSettings() {
  const body = {};
  const name=document.getElementById('ps-name').value.trim(); if(name) body.name=name;
  const email=document.getElementById('ps-email').value.trim(); if(email) body.email=email;
  const mobile=document.getElementById('ps-mobile').value.trim(); body.mobile=mobile;
  const pass=document.getElementById('ps-pass').value; if(pass) body.password=pass;
  body.notif_pref=document.getElementById('ps-notif').value;
  try {
    const updated = await api('/players/me', {method:'PATCH', body:JSON.stringify(body)});
    currentUser = updated; setStoredUser(updated);
    showToast('Settings saved','success'); render();
  } catch(e) { showToast(e.message,'error'); }
}

// â•â•â• OWNER SETTINGS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderOwnerSettings() {
  if(!isOwner()) return '<p>Access denied.</p>';
  const s = cachedSettings;
  if(!s) return renderSpinner();
  const locList = s.locations.map((l,i)=>
    `<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);">
      <span style="font-size:14px;">${esc(l)}</span>
      <button class="btn-danger btn-sm" onclick="removeLocation('${esc(l).replace(/'/g,"\\'")}')">âœ•</button></div>`
  ).join('');
  return `<div class="fade-in" style="max-width:600px;">
    <h2 style="font-weight:800;font-size:24px;margin-bottom:20px;">Admin Settings</h2>
    <div class="card" style="margin-bottom:16px;"><h3 style="font-size:16px;font-weight:700;margin-bottom:16px;">Game Defaults</h3>
      <div style="display:grid;gap:16px;">
        <div><label>Default Algorithm</label><select id="os-alg">
          <option value="first_come" ${s.default_algorithm==='first_come'?'selected':''}>First Come</option>
          <option value="random" ${s.default_algorithm==='random'?'selected':''}>Random</option></select></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div><label>Default Cap</label><input type="number" id="os-cap" value="${s.default_cap}" min="2" max="100"></div>
          <div style="display:flex;align-items:end;gap:8px;padding-bottom:2px;">
            <label class="toggle" style="margin-bottom:0;"><input type="checkbox" id="os-cap-on" ${s.cap_enabled?'checked':''}><span class="slider"></span></label>
            <span style="font-size:13px;">Cap enabled</span></div></div>
      </div></div>
    <div class="card" style="margin-bottom:16px;"><h3 style="font-size:16px;font-weight:700;margin-bottom:16px;">Notification Delays</h3>
      <div style="display:grid;gap:16px;">
        <div><label>High Priority â†’ Standard Delay (minutes)</label><input type="number" id="os-hp-delay" value="${s.high_priority_delay_minutes}" min="0"></div>
        <div><label>Standard â†’ Alternative Delay (minutes)</label><input type="number" id="os-alt-delay" value="${s.alternative_delay_minutes}" min="0"></div>
        <div><label>Random Wait Period (minutes)</label><input type="number" id="os-rand-wait" value="${s.random_wait_period_minutes}" min="0"></div>
        <div style="display:flex;align-items:center;gap:8px;">
          <label class="toggle" style="margin-bottom:0;"><input type="checkbox" id="os-notify-new" ${s.notify_owner_new_signup?'checked':''}><span class="slider"></span></label>
          <span style="font-size:13px;">Notify owners of new player signups</span></div>
        <button class="btn-primary" onclick="saveOwnerSettings()">Save Settings</button>
      </div></div>
    <div class="card"><h3 style="font-size:16px;font-weight:700;margin-bottom:16px;">Locations</h3>${locList}
      <div style="display:flex;gap:8px;margin-top:12px;"><input id="os-new-loc" placeholder="New location name" style="flex:1;">
        <button class="btn-primary btn-sm" onclick="addLocation()">Add</button></div></div></div>`;
}

async function saveOwnerSettings() {
  try {
    await api('/settings', { method:'PATCH', body:JSON.stringify({
      default_algorithm: document.getElementById('os-alg').value,
      default_cap: parseInt(document.getElementById('os-cap').value),
      cap_enabled: document.getElementById('os-cap-on').checked,
      high_priority_delay_minutes: parseInt(document.getElementById('os-hp-delay').value),
      alternative_delay_minutes: parseInt(document.getElementById('os-alt-delay').value),
      random_wait_period_minutes: parseInt(document.getElementById('os-rand-wait').value),
      notify_owner_new_signup: document.getElementById('os-notify-new').checked,
    })});
    showToast('Settings saved','success'); await fetchSettings(); render();
  } catch(e) { showToast(e.message,'error'); }
}

async function addLocation() {
  const name = document.getElementById('os-new-loc').value.trim();
  if(!name) return;
  try { await api('/settings/locations',{method:'POST',body:JSON.stringify({name})}); showToast('Location added','success'); await fetchSettings(); render(); }
  catch(e) { showToast(e.message,'error'); }
}

async function removeLocation(name) {
  try { await api(`/settings/locations/${encodeURIComponent(name)}`,{method:'DELETE'}); showToast('Location removed','success'); await fetchSettings(); render(); }
  catch(e) { showToast(e.message,'error'); }
}

// â•â•â• PLAYER MANAGEMENT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPlayerMgmt() {
  if(!isOwner()) return '<p>Access denied.</p>';
  const pending = cachedPlayers.filter(p=>p.status==='pending');
  const approved = cachedPlayers.filter(p=>p.status==='approved');
  return `<div class="fade-in">
    <h2 style="font-weight:800;font-size:24px;margin-bottom:20px;">Player Management</h2>
    ${pending.length>0?`<div class="alert-bar"><span style="font-size:18px;">âš </span><span><strong>${pending.length}</strong> player${pending.length!==1?'s':''} awaiting approval</span></div>`:''}
    <div class="tabs">
      <div class="tab ${mgmtTab==='pending'?'active':''}" onclick="mgmtTab='pending';render()">Pending${pending.length?` (${pending.length})`:''}</div>
      <div class="tab ${mgmtTab==='roster'?'active':''}" onclick="mgmtTab='roster';render()">Roster (${approved.length})</div>
      <div class="tab ${mgmtTab==='add'?'active':''}" onclick="mgmtTab='add';render()">Add Player</div>
    </div>
    ${mgmtTab==='pending'?renderPendingPlayers(pending):''}
    ${mgmtTab==='roster'?renderRoster(approved):''}
    ${mgmtTab==='add'?renderAddPlayer():''}
  </div>`;
}

function renderPendingPlayers(pending) {
  if(!pending.length) return `<div class="card" style="text-align:center;padding:40px;"><p style="color:var(--text2);">No pending approvals</p></div>`;
  const rows = pending.map(p=>`<tr>
    <td><strong>${esc(p.name)}</strong></td><td>${esc(p.email)}</td><td>${esc(p.mobile)||'â€”'}</td>
    <td><select class="approve-priority" data-id="${p.id}" style="width:auto;padding:4px 8px;font-size:12px;">
      <option value="high">High</option><option value="standard" selected>Standard</option><option value="low">Low</option></select></td>
    <td><div style="display:flex;gap:4px;">
      <button class="btn-primary btn-sm" onclick="approvePlayer(${p.id})">Approve</button>
      <button class="btn-danger btn-sm" onclick="denyPlayer(${p.id})">Deny</button></div></td></tr>`).join('');
  return `<div class="card" style="overflow-x:auto;"><table class="data-table"><thead><tr><th>Name</th><th>Email</th><th>Mobile</th><th>Priority</th><th>Actions</th></tr></thead><tbody>${rows}</tbody></table></div>`;
}

function renderRoster(approved) {
  const rows = approved.map(p=>{
    const roleBadge = p.role==='owner'?`<span class="badge badge-green">Owner</span>`:'';
    const roleBtn = p.id!==currentUser.id ? (p.role==='owner'
      ? `<button class="btn-secondary btn-sm" onclick="setRole(${p.id},'player')">Remove Owner</button>`
      : `<button class="btn-secondary btn-sm" onclick="setRole(${p.id},'owner')">Make Owner</button>`) : '';
    return `<tr>
      <td><strong>${esc(p.name)}</strong> ${roleBadge}</td><td>${esc(p.email)}</td><td>${esc(p.mobile)||'â€”'}</td>
      <td><select style="width:auto;padding:4px 8px;font-size:12px;" onchange="setPriority(${p.id},this.value)">
        <option value="high" ${p.priority==='high'?'selected':''}>High</option>
        <option value="standard" ${p.priority==='standard'?'selected':''}>Standard</option>
        <option value="low" ${p.priority==='low'?'selected':''}>Low</option></select></td>
      <td><div style="display:flex;gap:4px;flex-wrap:wrap;">
        ${roleBtn}
        <button class="btn-secondary btn-sm" onclick="resetPlayerPass(${p.id})">Reset PW</button>
        ${p.id!==currentUser.id?`<button class="btn-danger btn-sm" onclick="deletePlayer(${p.id})">Delete</button>`:''}</div></td></tr>`;
  }).join('');
  return `<div class="card" style="overflow-x:auto;"><table class="data-table"><thead><tr><th>Name</th><th>Email</th><th>Mobile</th><th>Priority</th><th>Actions</th></tr></thead><tbody>${rows}</tbody></table></div>`;
}

function renderAddPlayer() {
  return `<div class="card" style="max-width:400px;">
    <h3 style="font-size:16px;font-weight:700;margin-bottom:16px;">Add Individual Player</h3>
    <div style="display:grid;gap:12px;">
      <div><label>Name</label><input id="ap-name" placeholder="Full name"></div>
      <div><label>Email</label><input type="email" id="ap-email" placeholder="email@example.com"></div>
      <div><label>Mobile</label><input type="tel" id="ap-mobile" placeholder="555-0123"></div>
      <div><label>Priority</label><select id="ap-priority"><option value="high">High</option><option value="standard" selected>Standard</option><option value="low">Low</option></select></div>
      <p style="font-size:12px;color:var(--text2);margin:0;">Default password = their email. They'll be prompted to change it on first login.</p>
      <button class="btn-primary" onclick="addNewPlayer()">Add Player</button>
    </div>
    <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--border);">
      <h3 style="font-size:16px;font-weight:700;margin-bottom:12px;">Import CSV</h3>
      <p style="font-size:13px;color:var(--text2);margin-bottom:12px;">CSV format: name, email, mobile (one per line). Default password = email.</p>
      <textarea id="csv-import" rows="4" placeholder="John Doe,john@email.com,555-0123"></textarea>
      <button class="btn-secondary" style="margin-top:8px;width:100%;" onclick="importCSV()">Import Players</button>
    </div></div>`;
}

async function approvePlayer(id) {
  const sel = document.querySelector(`.approve-priority[data-id="${id}"]`);
  const priority = sel ? sel.value : 'standard';
  try { await api(`/admin/players/${id}/approve?priority=${priority}`,{method:'POST'}); showToast('Player approved','success'); await fetchPlayers(); await fetchPendingCount(); render(); }
  catch(e) { showToast(e.message,'error'); }
}
async function denyPlayer(id) {
  try { await api(`/admin/players/${id}/deny`,{method:'POST'}); showToast('Player denied','success'); await fetchPlayers(); await fetchPendingCount(); render(); }
  catch(e) { showToast(e.message,'error'); }
}
async function setPriority(id, priority) {
  try { await api(`/admin/players/${id}`,{method:'PATCH',body:JSON.stringify({priority})}); showToast(`Priority updated`,'success'); await fetchPlayers(); render(); }
  catch(e) { showToast(e.message,'error'); }
}
async function setRole(id, role) {
  const action = role==='owner' ? 'Make this player an owner?' : 'Remove owner access from this player?';
  if(!confirm(action)) return;
  try { await api(`/admin/players/${id}`,{method:'PATCH',body:JSON.stringify({role})}); showToast(role==='owner'?'Player is now an owner':'Owner access removed','success'); await fetchPlayers(); render(); }
  catch(e) { showToast(e.message,'error'); }
}
async function resetPlayerPass(id) {
  try { const r = await api(`/admin/players/${id}/reset-password`,{method:'POST'}); showToast(r.message,'success'); }
  catch(e) { showToast(e.message,'error'); }
}
async function deletePlayer(id) {
  if(!confirm('Delete this player? This cannot be undone.')) return;
  try { await api(`/admin/players/${id}`,{method:'DELETE'}); showToast('Player deleted','success'); await fetchPlayers(); render(); }
  catch(e) { showToast(e.message,'error'); }
}
async function addNewPlayer() {
  const name=document.getElementById('ap-name').value.trim(), email=document.getElementById('ap-email').value.trim();
  const mobile=document.getElementById('ap-mobile').value.trim(), priority=document.getElementById('ap-priority').value;
  if(!name||!email) { showToast('Name and email required','error'); return; }
  try {
    await api(`/admin/players/add?priority=${priority}`,{method:'POST',body:JSON.stringify({name,email,mobile,notif_pref:'email'})});
    showToast(`${name} added!`,'success'); await fetchPlayers(); render();
  } catch(e) { showToast(e.message,'error'); }
}
async function importCSV() {
  const text = document.getElementById('csv-import').value.trim();
  if(!text) return;
  const blob = new Blob([text], {type:'text/csv'});
  const formData = new FormData();
  formData.append('file', blob, 'import.csv');
  try {
    const token = getToken();
    const res = await fetch(API_BASE + '/admin/players/import', {
      method:'POST', headers:{'Authorization':`Bearer ${token}`}, body:formData
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.detail);
    showToast(`${data.added} player(s) imported`,'success');
    if(data.errors.length) console.warn('Import errors:', data.errors);
    await fetchPlayers(); render();
  } catch(e) { showToast(e.message,'error'); }
}

// â•â•â• NAVIGATION & LIFECYCLE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function navigate(page) {
  currentPage = page;
  mobileMenuOpen = false;
  render(); // Render immediately with cached data
  window.scrollTo(0,0);
  if (currentUser) {
    await loadPageData();
    render(); // Re-render with fresh data
  }
}

async function doLogout() {
  try { await api('/auth/logout',{method:'POST'}); } catch {}
  clearToken(); currentUser = null; currentPage = 'login';
  cachedGames=[]; cachedPlayers=[]; cachedSettings=null; cachedPendingCount=0;
  stopGameRefresh();
  render();
}

function toggleMobileMenu() { mobileMenuOpen=!mobileMenuOpen; render(); }
function closeMobileMenu(e) { if(e.target.classList.contains('mobile-menu')){ mobileMenuOpen=false; render(); } }

function bindEvents() {
  const dt = document.getElementById('cg-delay-notif');
  if(dt) { const f=document.getElementById('cg-delay-fields'); if(f) f.style.display=dt.checked?'grid':'none'; dt.onchange=()=>{ f.style.display=dt.checked?'grid':'none'; }; }
  updateCountdowns();
}

// Countdown timers for auto-selection and cascade
let countdownTimer = null;
function updateCountdowns() {
  if(countdownTimer) clearInterval(countdownTimer);
  const els = document.querySelectorAll('[data-target]');
  if(!els.length) return;
  function tick() {
    els.forEach(el => {
      const target = new Date(el.dataset.target);
      const now = new Date();
      const diff = target - now;
      if(diff <= 0) {
        el.textContent = el.classList.contains('cascade-cd') ? '(done)' : 'Auto-selecting now...';
        return;
      }
      const hrs = Math.floor(diff/3600000);
      const mins = Math.floor((diff%3600000)/60000);
      const secs = Math.floor((diff%60000)/1000);
      let timeStr;
      if(hrs > 0) timeStr = `${hrs}h ${mins}m`;
      else if(mins > 0) timeStr = `${mins}m ${secs}s`;
      else timeStr = `${secs}s`;

      if (el.classList.contains('cascade-cd')) {
        el.textContent = `in ${timeStr}`;
      } else {
        el.textContent = `â± Auto-selects in ${timeStr}`;
      }
    });
  }
  tick();
  countdownTimer = setInterval(tick, 1000);
}

// Auto-refresh games every 30s
function startGameRefresh() {
  stopGameRefresh();
  gameRefreshTimer = setInterval(async ()=>{
    if(currentPage==='games' && currentUser) {
      await fetchGames();
      render();
    }
  }, 30000);
}
function stopGameRefresh() { if(gameRefreshTimer) { clearInterval(gameRefreshTimer); gameRefreshTimer=null; } }

// â•â•â• INIT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(async function init() {
  // Check for password reset token in URL
  const params = new URLSearchParams(window.location.search);
  const resetToken = params.get('reset');
  if (resetToken) {
    currentPage = 'reset_password';
    window._resetToken = resetToken;
    render();
    return;
  }

  if (currentUser && getToken()) {
    // Validate stored session
    try {
      const me = await api('/players/me');
      currentUser = me; setStoredUser(me);

      if (currentUser.force_password_change) {
        currentPage = 'force_change_pw';
        render();
        return;
      }

      currentPage = 'games';
      await loadPageData();
      render();
      startGameRefresh();
      if(isOwner() && cachedPendingCount>0) showToast(`${cachedPendingCount} player(s) awaiting approval`,'info');
    } catch {
      // Token invalid
      clearToken(); currentUser=null; currentPage='login'; render();
    }
  } else {
    render();
  }
})();
</script>
</body>
</html>

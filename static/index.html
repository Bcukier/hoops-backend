<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" href="/static/favicon.png?v=3">
<link rel="apple-touch-icon" href="/static/icon-192.png?v=3">
<title>GOATcommish â€” Pickup Basketball</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800;900&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0d0d0f;
  --surface: #18181b;
  --surface2: #232328;
  --border: #2e2e35;
  --text: #f0f0f2;
  --text2: #9a9aab;
  --orange: #ff6a2f;
  --orange-glow: rgba(255,106,47,0.15);
  --green: #22c55e;
  --red: #ef4444;
  --grey: #71717a;
  --blue: #3b82f6;
}
* { box-sizing: border-box; margin:0; padding:0; }
body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }
h1,h2,h3,h4,h5 { font-family:'Outfit',sans-serif; }
::-webkit-scrollbar { width:6px; height:6px; }
::-webkit-scrollbar-track { background:var(--surface); }
::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
.glow-border { border:1px solid rgba(255,106,47,0.3); box-shadow:0 0 20px var(--orange-glow); }
.btn-primary { background:var(--orange); color:#fff; font-family:'Outfit',sans-serif; font-weight:600; padding:10px 24px; border:none; border-radius:8px; cursor:pointer; transition:all .2s; font-size:14px; }
.btn-primary:hover:not(:disabled) { background:#e85a20; transform:translateY(-1px); box-shadow:0 4px 15px var(--orange-glow); }
.btn-primary:disabled { opacity:0.5; cursor:not-allowed; }
.btn-secondary { background:var(--surface2); color:var(--text); font-family:'Outfit',sans-serif; font-weight:500; padding:10px 24px; border:1px solid var(--border); border-radius:8px; cursor:pointer; transition:all .2s; font-size:14px; }
.btn-secondary:hover { background:var(--border); }
.btn-danger { background:rgba(239,68,68,0.15); color:var(--red); font-family:'Outfit',sans-serif; font-weight:600; padding:10px 24px; border:1px solid rgba(239,68,68,0.3); border-radius:8px; cursor:pointer; transition:all .2s; font-size:14px; }
.btn-danger:hover { background:rgba(239,68,68,0.25); }
.btn-sm { padding:6px 14px; font-size:12px; }
input,select,textarea { background:var(--surface2); color:var(--text); border:1px solid var(--border); border-radius:8px; padding:10px 14px; font-family:'DM Sans',sans-serif; font-size:14px; width:100%; outline:none; transition:border .2s; }
input:focus,select:focus,textarea:focus { border-color:var(--orange); }
select { cursor:pointer; }
label { font-size:13px; color:var(--text2); font-weight:500; display:block; margin-bottom:4px; }
.card { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:20px; }
@keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
@keyframes slideIn { from{opacity:0;transform:translateX(-20px)} to{opacity:1;transform:translateX(0)} }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
@keyframes spin { to{transform:rotate(360deg)} }
.fade-in { animation:fadeIn .4s ease-out; }
.slide-in { animation:slideIn .3s ease-out; }
.toast { position:fixed; bottom:24px; right:24px; background:var(--surface2); border:1px solid var(--border); border-radius:12px; padding:14px 20px; z-index:1000; animation:fadeIn .3s ease-out; display:flex; align-items:center; gap:10px; font-size:14px; max-width:380px; }
.toast.success { border-color:rgba(34,197,94,0.4); }
.toast.error { border-color:rgba(239,68,68,0.4); }
.toast.info { border-color:rgba(59,130,246,0.4); }
nav { background:var(--surface); border-bottom:1px solid var(--border); padding:0 20px; position:sticky; top:0; z-index:100; }
nav .inner { max-width:1200px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; height:60px; }
nav .logo { font-family:'Outfit',sans-serif; font-weight:900; font-size:22px; color:var(--orange); display:flex; align-items:center; gap:8px; cursor:pointer; }
nav .logo span { color:var(--text); font-weight:600; font-size:14px; opacity:0.6; }
nav .nav-links { display:flex; gap:4px; align-items:center; }
nav .nav-links a { color:var(--text2); text-decoration:none; padding:8px 14px; border-radius:6px; font-size:13px; font-weight:500; transition:all .2s; cursor:pointer; }
nav .nav-links a:hover, nav .nav-links a.active { color:var(--text); background:var(--surface2); }
.hamburger { display:none; background:none; border:none; color:var(--text); cursor:pointer; font-size:24px; }
.mobile-menu { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:200; }
.mobile-menu.open { display:flex; }
.mobile-menu-content { background:var(--surface); width:280px; height:100%; padding:20px; animation:slideIn .3s ease-out; }
.mobile-menu a { display:block; color:var(--text2); text-decoration:none; padding:12px 14px; border-radius:8px; font-size:15px; margin-bottom:4px; }
.mobile-menu a:hover, .mobile-menu a.active { color:var(--text); background:var(--surface2); }
.games-grid { display:flex; gap:16px; overflow-x:auto; padding:20px 0; min-height:400px; }
.game-col { min-width:240px; max-width:280px; flex-shrink:0; background:var(--surface); border:1px solid var(--border); border-radius:16px; overflow:hidden; }
.game-header { padding:16px; border-bottom:1px solid var(--border); text-align:center; }
.game-header .weekday { font-family:'Outfit',sans-serif; font-weight:800; font-size:18px; text-transform:uppercase; letter-spacing:1px; }
.game-header .date { font-size:13px; color:var(--text2); margin-top:2px; }
.game-header .time-loc { font-size:12px; color:var(--text2); margin-top:6px; }
.game-header .cap { font-size:11px; color:var(--grey); margin-top:4px; }
.game-action { padding:12px 16px; border-bottom:1px solid var(--border); }
.game-players { padding:8px; max-height:500px; overflow-y:auto; }
.player-slot { padding:8px 12px; border-radius:6px; font-size:13px; margin:2px 0; display:flex; align-items:center; gap:8px; }
.player-slot.in-game { color:var(--green); }
.player-slot.waitlist { color:var(--red); }
.player-slot.pending { color:var(--grey); }
.player-slot .num { font-weight:600; font-size:11px; min-width:20px; }
.empty-slot { border:1px dashed var(--border); padding:8px 12px; border-radius:6px; margin:2px 0; height:36px; }
.waitlist-divider { font-size:10px; color:var(--red); text-transform:uppercase; letter-spacing:1px; padding:8px 12px; font-weight:600; opacity:0.7; }
.data-table { width:100%; border-collapse:collapse; }
.data-table th { text-align:left; padding:10px 14px; font-size:12px; color:var(--text2); text-transform:uppercase; letter-spacing:0.5px; border-bottom:1px solid var(--border); font-weight:500; }
.data-table td { padding:10px 14px; font-size:14px; border-bottom:1px solid var(--border); }
.data-table tr:hover td { background:var(--surface2); }
.badge { display:inline-block; padding:2px 8px; border-radius:4px; font-size:11px; font-weight:600; }
.badge-green { background:rgba(34,197,94,0.15); color:var(--green); }
.badge-red { background:rgba(239,68,68,0.15); color:var(--red); }
.badge-orange { background:var(--orange-glow); color:var(--orange); }
.badge-blue { background:rgba(59,130,246,0.15); color:var(--blue); }
.badge-grey { background:rgba(113,113,122,0.15); color:var(--grey); }
.alert-bar { background:rgba(255,106,47,0.1); border:1px solid rgba(255,106,47,0.3); border-radius:10px; padding:12px 16px; display:flex; align-items:center; gap:10px; margin-bottom:16px; font-size:13px; }
.invitation-card { display:flex; align-items:center; justify-content:space-between; padding:12px; background:var(--surface2); border-radius:8px; border:1px solid var(--border); }
.tabs { display:flex; gap:2px; background:var(--surface2); border-radius:8px; padding:2px; margin-bottom:20px; }
.tab { padding:8px 16px; border-radius:6px; font-size:13px; font-weight:500; cursor:pointer; color:var(--text2); transition:all .2s; flex:1; text-align:center; }
.tab.active { background:var(--surface); color:var(--text); }
.toggle { position:relative; width:44px; height:24px; cursor:pointer; }
.toggle input { opacity:0; width:0; height:0; }
.toggle .slider { position:absolute; inset:0; background:var(--surface2); border:1px solid var(--border); border-radius:12px; transition:.3s; }
.toggle .slider:before { content:''; position:absolute; height:18px; width:18px; left:2px; bottom:2px; background:var(--text2); border-radius:50%; transition:.3s; }
.toggle input:checked + .slider { background:var(--orange); border-color:var(--orange); }
.toggle input:checked + .slider:before { transform:translateX(20px); background:#fff; }
.spinner { display:inline-block; width:18px; height:18px; border:2px solid var(--border); border-top-color:var(--orange); border-radius:50%; animation:spin .6s linear infinite; }
.loading-overlay { display:flex; align-items:center; justify-content:center; padding:60px; }
@media (max-width:768px) {
  .nav-links { display:none !important; }
  .hamburger { display:block !important; }
  .games-grid { padding:12px 0; }
  .game-col { min-width:220px; }
}
</style>
</head>
<body>
<div id="app"></div>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API CLIENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API_BASE = window.location.origin + '/api';

function getToken() { return localStorage.getItem('hoops_token'); }
function setToken(t) { localStorage.setItem('hoops_token', t); }
function clearToken() { localStorage.removeItem('hoops_token'); localStorage.removeItem('hoops_user'); }
function getStoredUser() { try { return JSON.parse(localStorage.getItem('hoops_user')); } catch { return null; } }
function setStoredUser(u) { localStorage.setItem('hoops_user', JSON.stringify(u)); }

async function api(path, opts = {}) {
  const headers = { 'Content-Type': 'application/json', ...opts.headers };
  const token = getToken();
  if (token) headers['Authorization'] = `Bearer ${token}`;
  const res = await fetch(API_BASE + path, { ...opts, headers });
  if (res.status === 401) {
    clearToken();
    currentUser = null;
    currentPage = 'login';
    render();
    throw new Error('Session expired');
  }
  const data = await res.json();
  if (!res.ok) {
    // FastAPI returns {detail: string} for HTTPException
    // and {detail: [{msg, loc, type},...]} for validation errors (422)
    let msg = `Error ${res.status}`;
    if (typeof data.detail === 'string') {
      msg = data.detail;
    } else if (Array.isArray(data.detail) && data.detail.length > 0) {
      msg = data.detail.map(e => `${e.loc?.slice(-1)?.[0] || 'field'}: ${e.msg}`).join(', ');
    }
    throw new Error(msg);
  }
  return data;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

let currentUser = getStoredUser();
let currentPage = currentUser ? 'games' : 'login';
let mobileMenuOpen = false;
let loading = false;

// Cached data from API
let cachedGames = [];
let cachedPlayers = [];
let cachedSettings = null;
let cachedLocations = [];

let mgmtTab = 'roster';
let rosterSort = 'priority'; // 'priority', 'first', 'last'
let cgPlayerSort = 'priority'; // sort for game creation player list
let gameRefreshTimer = null;
let ownerViewMode = true;
let selectedOrgGroupId = null; // which group the organizer is managing
let invitationPromptShown = false; // don't show twice per session

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function isOwner() { return currentUser && currentUser.role === 'owner'; }
function isOrganizer() { return currentUser && currentUser.groups && currentUser.groups.some(g => g.role === 'organizer' && g.status === 'active'); }
function myGroups() { return (currentUser && currentUser.groups) ? currentUser.groups.filter(g => g.status === 'active') : []; }
function orgGroups() { return myGroups().filter(g => g.role === 'organizer'); }
function pendingInvitations() { return (currentUser && currentUser.pending_invitations) ? currentUser.pending_invitations : []; }
function activeOrgGroupId() {
  const og = orgGroups();
  if (!og.length) return null;
  if (selectedOrgGroupId && og.find(g => g.group_id === selectedOrgGroupId)) return selectedOrgGroupId;
  // Check localStorage default
  const def = localStorage.getItem('hoops_default_org_group');
  if (def && og.find(g => g.group_id === parseInt(def))) { selectedOrgGroupId = parseInt(def); return selectedOrgGroupId; }
  selectedOrgGroupId = og[0].group_id;
  return selectedOrgGroupId;
}
function changeOrgGroup(gid) {
  selectedOrgGroupId = gid;
  cachedPlayers = []; cachedSettings = null; cachedLocations = [];
  loadPageData().then(() => render());
}
function setDefaultOrgGroup(gid) {
  localStorage.setItem('hoops_default_org_group', gid);
  showToast('Default group updated', 'success');
}
function renderGroupSelector() {
  const og = orgGroups();
  if (og.length <= 1) return '';
  const gid = activeOrgGroupId();
  const defGid = parseInt(localStorage.getItem('hoops_default_org_group') || '0');
  const opts = og.map(g => `<option value="${g.group_id}" ${g.group_id===gid?'selected':''}>${esc(g.group_name)}</option>`).join('');
  return `<div class="card" style="margin-bottom:16px;padding:12px 16px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
    <label style="margin:0;font-weight:600;white-space:nowrap;">Group:</label>
    <select style="flex:1;min-width:120px;max-width:250px;" onchange="changeOrgGroup(parseInt(this.value))">${opts}</select>
    ${gid !== defGid ? `<button class="btn-secondary btn-sm" onclick="setDefaultOrgGroup(${gid})">Set as Default</button>` : `<span class="badge badge-green">Default</span>`}
  </div>`;
}
async function respondInvitation(token, action) {
  try {
    await api(`/invitations/${token}/${action}`, {method:'POST'});
    showToast(action === 'accept' ? 'Invitation accepted!' : 'Invitation declined', 'success');
    const me = await api('/me'); currentUser = me; setStoredUser(me);
    await loadPageData(); render();
  } catch(e) { showToast(e.message, 'error'); }
}
function showInvitationPrompt() {
  const invs = pendingInvitations();
  if (!invs.length || invitationPromptShown) return;
  invitationPromptShown = true;
  const cards = invs.map(inv => `<div style="display:flex;align-items:center;justify-content:space-between;padding:12px;background:var(--surface2);border-radius:8px;margin-bottom:8px;">
    <div><div style="font-weight:600;">${esc(inv.group_name)}</div>
    <div style="font-size:12px;color:var(--text2);">Invited by ${esc(inv.invited_by_name)}</div></div>
    <div style="display:flex;gap:6px;">
      <button class="btn-primary btn-sm" onclick="respondInvitation('${inv.token}','accept');document.getElementById('inv-prompt-modal')?.remove()">Accept</button>
      <button class="btn-danger btn-sm" onclick="respondInvitation('${inv.token}','decline');document.getElementById('inv-prompt-modal')?.remove()">Decline</button>
    </div></div>`).join('');
  const html = `<div id="inv-prompt-modal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px;" onclick="if(event.target===this)this.remove()">
    <div class="card glow-border" style="max-width:420px;width:100%;">
      <h3 style="font-size:18px;font-weight:700;margin-bottom:4px;">ğŸ“¬ Group Invitations</h3>
      <p style="font-size:13px;color:var(--text2);margin-bottom:16px;">You've been invited to join ${invs.length > 1 ? 'these groups' : 'a group'}:</p>
      ${cards}
      <button class="btn-secondary" style="width:100%;margin-top:8px;" onclick="document.getElementById('inv-prompt-modal').remove()">Skip for Now</button>
    </div></div>`;
  document.body.insertAdjacentHTML('beforeend', html);
}
function formatDate(iso) { const d = new Date(iso); return `${MONTHS[d.getMonth()]} ${d.getDate()}`; }
function formatTime(iso) { const d = new Date(iso); let h=d.getHours(),m=d.getMinutes(); const ap=h>=12?'PM':'AM'; h=h%12||12; return `${h}:${m.toString().padStart(2,'0')} ${ap}`; }
function formatWeekday(iso) { return DAYS[new Date(iso).getDay()]; }
function isGameStarted(game) { return new Date(game.date).getTime() < Date.now(); }

// Notification preference multi-select helpers
function getNotifPref(prefix) {
  const none = document.querySelector(`.${prefix}-notif-none`);
  if (none && none.checked) return 'none';
  const checked = [...document.querySelectorAll(`.${prefix}-notif-ch:checked`)].map(cb => cb.value);
  return checked.length ? checked.join(',') : 'email';
}
function handleNotifCheckbox(el, prefix) {
  if (el.checked) {
    const none = document.querySelector(`.${prefix}-notif-none`);
    if (none) none.checked = false;
  }
}
function handleNotifNone(el, prefix) {
  if (el.checked) {
    document.querySelectorAll(`.${prefix}-notif-ch`).forEach(cb => cb.checked = false);
  }
}
function esc(s) { const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

function showToast(msg, type='info') {
  document.querySelectorAll('.toast').forEach(t=>t.remove());
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  const icons = {success:'âœ“',error:'âœ•',info:'â„¹'};
  t.innerHTML = `<span style="font-size:18px">${icons[type]||'â„¹'}</span> ${esc(msg)}`;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(), 3500);
}

function setLoading(v) { loading = v; }

function renderSpinner() {
  return `<div class="loading-overlay"><div class="spinner"></div></div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA FETCHING (group-scoped)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchGames() {
  try {
    const view = isOrganizer() && ownerViewMode ? 'organizer' : 'player';
    cachedGames = await api(`/games?view=${view}`);
  } catch(e) { console.error('fetchGames:', e); cachedGames=[]; }
}

async function fetchPlayers() {
  const gid = activeOrgGroupId();
  if (!isOrganizer() || !gid) return;
  try { cachedPlayers = await api(`/groups/${gid}/members`); } catch(e) { console.error('fetchPlayers:', e); cachedPlayers=[]; }
}

async function fetchSettings() {
  const gid = activeOrgGroupId();
  if (!isOrganizer() || !gid) return;
  try { cachedSettings = await api(`/groups/${gid}/settings`); cachedLocations = cachedSettings.locations||[]; } catch(e) { console.error('fetchSettings:', e); }
}

async function fetchLocations() {
  const gid = activeOrgGroupId();
  if (!gid) return;
  try { cachedLocations = await api(`/groups/${gid}/locations`); } catch { cachedLocations=[]; }
}

async function loadPageData() {
  if (!currentUser) return;
  const p = [fetchGames()];
  if (isOrganizer() && activeOrgGroupId()) p.push(fetchLocations());
  if (['player_mgmt'].includes(currentPage)) p.push(fetchPlayers());
  if (['owner_settings'].includes(currentPage)) p.push(fetchSettings());
  if (['create_game'].includes(currentPage)) p.push(fetchPlayers(), fetchSettings());
  await Promise.all(p);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render() {
  const app = document.getElementById('app');
  if (currentPage === 'login') { app.innerHTML = renderLogin(); return; }
  if (currentPage === 'signup') { app.innerHTML = renderNewSignup(); return; }
  if (currentPage === 'reset_password') { app.innerHTML = renderResetPassword(); return; }
  if (currentPage === 'force_change_pw') { app.innerHTML = renderForceChangePassword(); return; }

  let nav = renderNav();
  let content = '';
  switch(currentPage) {
    case 'games': content = renderGames(); break;
    case 'create_game': content = renderCreateGame(); break;
    case 'player_settings': content = renderPlayerSettings(); break;
    case 'owner_settings': content = renderOwnerSettings(); break;
    case 'player_mgmt': content = renderPlayerMgmt(); break;
    case 'algorithm_info': content = renderAlgorithmInfo(); break;
    default: content = renderGames();
  }
  app.innerHTML = nav + `<main style="max-width:1200px;margin:0 auto;padding:20px;">${content}</main>`;
  bindEvents();
}

// â”€â”€ Countdown Ticker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// (handled by updateCountdowns in bindEvents)

function renderNav() {
  const invCount = pendingInvitations().length;
  const invBadge = invCount>0 ? `<span style="background:var(--orange);color:#fff;border-radius:50%;padding:1px 6px;font-size:10px;font-weight:700;margin-left:4px;">${invCount}</span>` : '';
  const org = isOrganizer();
  return `<nav><div class="inner">
    <div class="logo" onclick="navigate('games')"><img src="/static/icon-40.png?v=3" style="width:32px;height:32px;vertical-align:middle;border-radius:4px;">commish</div>
    <div class="nav-links">
      <a onclick="navigate('games')" class="${currentPage==='games'?'active':''}">Games</a>
      ${org?`<a onclick="navigate('create_game')" class="${currentPage==='create_game'?'active':''}">Create Game</a>`:''}
      ${org?`<a onclick="navigate('player_mgmt')" class="${currentPage==='player_mgmt'?'active':''}">Players</a>`:''}
      <a onclick="navigate('player_settings')" class="${currentPage==='player_settings'?'active':''}">Settings${invBadge}</a>
      ${org?`<a onclick="navigate('owner_settings')" class="${currentPage==='owner_settings'?'active':''}">Organizer</a>`:''}
      <a onclick="doLogout()" style="color:var(--red)">Logout</a>
    </div>
    <button class="hamburger" onclick="toggleMobileMenu()">â˜°</button>
  </div></nav>
  <div class="mobile-menu ${mobileMenuOpen?'open':''}" onclick="closeMobileMenu(event)">
    <div class="mobile-menu-content">
      <div class="logo" style="margin-bottom:20px;font-size:20px" onclick="navigate('games');mobileMenuOpen=false;"><img src="/static/icon-40.png?v=3" style="width:28px;height:28px;vertical-align:middle;border-radius:4px;">commish</div>
      <a onclick="navigate('games');mobileMenuOpen=false;" class="${currentPage==='games'?'active':''}">ğŸ® Games</a>
      ${org?`<a onclick="navigate('create_game');mobileMenuOpen=false;" class="${currentPage==='create_game'?'active':''}">â• Create Game</a>`:''}
      ${org?`<a onclick="navigate('player_mgmt');mobileMenuOpen=false;" class="${currentPage==='player_mgmt'?'active':''}">ğŸ‘¥ Players</a>`:''}
      <a onclick="navigate('player_settings');mobileMenuOpen=false;" class="${currentPage==='player_settings'?'active':''}">âš™ Settings${invBadge}</a>
      ${org?`<a onclick="navigate('owner_settings');mobileMenuOpen=false;" class="${currentPage==='owner_settings'?'active':''}">ğŸ”§ Organizer</a>`:''}
      <a onclick="doLogout()" style="color:var(--red)">ğŸšª Logout</a>
    </div>
  </div>`;
}

// â•â•â• LOGIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderLogin() {
  return `<div style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;">
    <div class="card glow-border fade-in" style="max-width:400px;width:100%;text-align:center;">
      <img src="/static/logo.png?v=3" style="width:200px;margin:0 auto 16px;display:block;">
      <p style="color:var(--text2);font-size:14px;margin-bottom:28px;">Pickup Basketball</p>
      <div style="text-align:left;">
        <label>Email</label>
        <input type="email" id="login-email" placeholder="you@example.com" style="margin-bottom:12px;">
        <label>Password</label>
        <input type="password" id="login-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" style="margin-bottom:20px;"
          onkeydown="if(event.key==='Enter')doLogin()">
        <button class="btn-primary" id="login-btn" style="width:100%;padding:12px;" onclick="doLogin()">Sign In</button>
      </div>
      <div style="margin-top:20px;display:flex;justify-content:center;gap:16px;font-size:13px;">
        <a style="color:var(--orange);cursor:pointer;" onclick="navigate('signup')">New player? Sign up</a>
        <a style="color:var(--text2);cursor:pointer;" onclick="doResetPassword()">Forgot password?</a>
      </div>
    </div>
  </div>`;
}

async function doLogin() {
  const email = document.getElementById('login-email').value.trim();
  const pass = document.getElementById('login-pass').value;
  if (!email || !pass) { showToast('Enter email and password','error'); return; }
  const btn = document.getElementById('login-btn');
  btn.disabled = true; btn.innerHTML = '<span class="spinner"></span>';
  try {
    const data = await api('/auth/login', { method:'POST', body:JSON.stringify({email,password:pass}) });
    setToken(data.access_token);
    currentUser = data.player;
    setStoredUser(currentUser);

    if (currentUser.force_password_change) {
      currentPage = 'force_change_pw';
      render();
      return;
    }

    currentPage = 'games';
    await loadPageData();
    render();
    startGameRefresh();
    // Show invitation prompt if pending
    setTimeout(() => showInvitationPrompt(), 500);
  } catch(e) {
    showToast(e.message,'error');
    btn.disabled = false; btn.textContent = 'Sign In';
  }
}

async function doResetPassword() {
  const email = document.getElementById('login-email').value.trim();
  if (!email) { showToast('Enter your email first','error'); return; }
  try { await api(`/auth/reset-password?email=${encodeURIComponent(email)}`, {method:'POST'}); showToast('Reset link sent if account exists','success'); } catch(e) { showToast(e.message,'error'); }
}

function renderResetPassword() {
  return `<div style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;">
    <div class="card glow-border fade-in" style="max-width:400px;width:100%;text-align:center;">
      <div style="font-size:48px;margin-bottom:8px;">ğŸ”‘</div>
      <h2 style="font-size:24px;font-weight:800;margin-bottom:4px;">Reset Password</h2>
      <p style="color:var(--text2);font-size:13px;margin-bottom:24px;">Enter your new password below.</p>
      <div style="text-align:left;">
        <label>New Password</label>
        <input type="password" id="reset-pass" placeholder="New password" style="margin-bottom:12px;">
        <label>Confirm Password</label>
        <input type="password" id="reset-pass2" placeholder="Confirm password" style="margin-bottom:20px;"
          onkeydown="if(event.key==='Enter')doConfirmReset()">
        <button class="btn-primary" id="reset-btn" style="width:100%;padding:12px;" onclick="doConfirmReset()">Set New Password</button>
      </div>
      <p style="margin-top:16px;font-size:13px;"><a style="color:var(--orange);cursor:pointer;" onclick="window.history.replaceState({},'','/');navigate('login')">â† Back to login</a></p>
    </div>
  </div>`;
}

async function doConfirmReset() {
  const pass = document.getElementById('reset-pass').value;
  const pass2 = document.getElementById('reset-pass2').value;
  if (!pass || pass.length < 4) { showToast('Password must be at least 4 characters','error'); return; }
  if (pass !== pass2) { showToast('Passwords do not match','error'); return; }
  const btn = document.getElementById('reset-btn');
  btn.disabled = true; btn.innerHTML = '<span class="spinner"></span>';
  try {
    const token = window._resetToken;
    const r = await api(`/auth/reset-password/confirm?token=${encodeURIComponent(token)}&new_password=${encodeURIComponent(pass)}`, {method:'POST'});
    showToast(r.message, 'success');
    window.history.replaceState({}, '', '/');
    setTimeout(() => navigate('login'), 1500);
  } catch(e) { showToast(e.message, 'error'); btn.disabled = false; btn.textContent = 'Set New Password'; }
}

// â•â•â• FORCED PASSWORD CHANGE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderForceChangePassword() {
  return `<div style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;">
    <div class="card glow-border fade-in" style="max-width:400px;width:100%;text-align:center;">
      <div style="font-size:48px;margin-bottom:8px;">ğŸ”</div>
      <h2 style="font-size:24px;font-weight:800;margin-bottom:4px;">Change Your Password</h2>
      <p style="color:var(--text2);font-size:13px;margin-bottom:24px;">Your account was created with a temporary password. Please set a new one to continue.</p>
      <div style="text-align:left;">
        <label>New Password</label>
        <input type="password" id="fcp-pass" placeholder="Choose a new password" style="margin-bottom:12px;">
        <label>Confirm Password</label>
        <input type="password" id="fcp-pass2" placeholder="Confirm new password" style="margin-bottom:20px;"
          onkeydown="if(event.key==='Enter')doForceChangePassword()">
        <button class="btn-primary" id="fcp-btn" style="width:100%;padding:12px;" onclick="doForceChangePassword()">Set Password &amp; Continue</button>
      </div>
    </div>
  </div>`;
}

async function doForceChangePassword() {
  const pass = document.getElementById('fcp-pass').value;
  const pass2 = document.getElementById('fcp-pass2').value;
  if (!pass || pass.length < 4) { showToast('Password must be at least 4 characters','error'); return; }
  if (pass !== pass2) { showToast('Passwords do not match','error'); return; }
  if (pass === currentUser.email) { showToast('Password cannot be your email address','error'); return; }
  const btn = document.getElementById('fcp-btn');
  btn.disabled = true; btn.innerHTML = '<span class="spinner"></span>';
  try {
    const updated = await api('/me', { method:'PATCH', body:JSON.stringify({password:pass}) });
    currentUser = updated;
    setStoredUser(currentUser);
    showToast('Password updated!','success');
    currentPage = 'games';
    await loadPageData();
    render();
    startGameRefresh();
  } catch(e) { showToast(e.message,'error'); btn.disabled=false; btn.textContent='Set Password & Continue'; }
}

// â•â•â• NEW PLAYER SIGNUP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderNewSignup() {
  return `<div style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;">
    <div class="card glow-border fade-in" style="max-width:420px;width:100%;text-align:center;">
      <h2 style="font-size:24px;font-weight:800;margin-bottom:4px;">Join the Run</h2>
      <p style="color:var(--text2);font-size:13px;margin-bottom:24px;">Sign up to play pickup basketball.</p>
      <div style="text-align:left;">
        <label>Full Name</label><input id="su-name" placeholder="Your name" style="margin-bottom:12px;">
        <label>Email</label><input type="email" id="su-email" placeholder="you@example.com" style="margin-bottom:12px;">
        <label>Mobile Phone</label><input type="tel" id="su-mobile" placeholder="555-0123" style="margin-bottom:12px;">
        <label>Password</label><input type="password" id="su-pass" placeholder="Choose a password" style="margin-bottom:12px;">
        <label>Notification Preference</label>
        <div id="su-notif-group" style="display:flex;gap:16px;flex-wrap:wrap;padding:4px 0;margin-bottom:20px;">
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:14px;"><input type="checkbox" class="su-notif-ch" value="email" checked style="width:auto;" onchange="handleNotifCheckbox(this,'su')"> Email</label>
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:14px;"><input type="checkbox" class="su-notif-ch" value="sms" style="width:auto;" onchange="handleNotifCheckbox(this,'su')"> SMS</label>
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:14px;"><input type="checkbox" class="su-notif-none" value="none" style="width:auto;" onchange="handleNotifNone(this,'su')"> None</label>
        </div>
        <div style="border-top:1px solid var(--border);padding-top:16px;margin-bottom:16px;">
          <label style="font-size:14px;font-weight:600;color:var(--text);margin-bottom:8px;">Join or Create a Group</label>
          <div class="tabs" style="margin-bottom:12px;">
            <div class="tab active" id="su-tab-join" onclick="document.getElementById('su-tab-join').classList.add('active');document.getElementById('su-tab-create').classList.remove('active');document.getElementById('su-join-fields').style.display='block';document.getElementById('su-create-fields').style.display='none';">Join Existing</div>
            <div class="tab" id="su-tab-create" onclick="document.getElementById('su-tab-create').classList.add('active');document.getElementById('su-tab-join').classList.remove('active');document.getElementById('su-create-fields').style.display='block';document.getElementById('su-join-fields').style.display='none';">Create New</div>
          </div>
          <div id="su-join-fields">
            <input id="su-join-q" placeholder="Group name or organizer's email" style="margin-bottom:4px;">
            <div style="font-size:11px;color:var(--text2);">Ask an organizer for the group name or enter their email.</div>
          </div>
          <div id="su-create-fields" style="display:none;">
            <input id="su-create-name" placeholder="New group name" style="margin-bottom:4px;">
            <div style="font-size:11px;color:var(--text2);">You'll be the organizer of this group.</div>
          </div>
        </div>
        <button class="btn-primary" id="su-btn" style="width:100%;padding:12px;" onclick="doSignup()">Sign Up</button>
      </div>
      <p style="margin-top:16px;font-size:13px;"><a style="color:var(--orange);cursor:pointer;" onclick="navigate('login')">â† Back to login</a></p>
    </div>
  </div>`;
}

async function doSignup() {
  const name=document.getElementById('su-name').value.trim(), email=document.getElementById('su-email').value.trim();
  const mobile=document.getElementById('su-mobile').value.trim(), pass=document.getElementById('su-pass').value;
  const notif=getNotifPref('su');
  if(!name||!email||!pass) { showToast('Fill in all required fields','error'); return; }

  // Determine group action
  const createFields = document.getElementById('su-create-fields');
  const isCreate = createFields && createFields.style.display !== 'none';
  let body = { name, email, mobile, password: pass, notif_pref: notif };

  if (isCreate) {
    const gname = document.getElementById('su-create-name').value.trim();
    if (!gname) { showToast('Enter a group name','error'); return; }
    body.create_group_name = gname;
  } else {
    const q = document.getElementById('su-join-q').value.trim();
    if (!q) { showToast('Enter a group name or organizer email to join','error'); return; }
    if (q.includes('@')) body.join_organizer_email = q;
    else body.join_group_name = q;
  }

  const btn=document.getElementById('su-btn'); btn.disabled=true; btn.innerHTML='<span class="spinner"></span>';
  try {
    const data = await api('/auth/signup', { method:'POST', body:JSON.stringify(body) });
    setToken(data.access_token);
    currentUser = data.player;
    setStoredUser(currentUser);
    showToast('Welcome to GOATcommish! ğŸ€','success');
    currentPage = 'games';
    await loadPageData();
    render();
    startGameRefresh();
  } catch(e) { showToast(e.message,'error'); btn.disabled=false; btn.textContent='Sign Up'; }
}

// â•â•â• GAMES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderGames() {
  if (loading) return renderSpinner();
  const games = cachedGames.sort((a,b)=>new Date(a.date)-new Date(b.date));
  if (!games.length) return `<div class="fade-in" style="text-align:center;padding:60px 20px;">
    <div style="font-size:64px;margin-bottom:16px;"><img src="/static/icon-192.png?v=3" style="width:80px;height:80px;"></div>
    <h2 style="font-weight:700;margin-bottom:8px;">No Games Available</h2>
    <p style="color:var(--text2);font-size:14px;">Check back later or ask an organizer to create a game.</p></div>`;

  const viewToggle = isOrganizer() ? `<div style="display:flex;align-items:center;gap:8px;">
    <span style="font-size:12px;color:${ownerViewMode?'var(--text2)':'var(--orange)'};cursor:pointer;" onclick="ownerViewMode=false;fetchGames().then(()=>render())">Player</span>
    <label class="toggle" style="margin:0;"><input type="checkbox" ${ownerViewMode?'checked':''} onchange="ownerViewMode=this.checked;fetchGames().then(()=>render())"><span class="slider"></span></label>
    <span style="font-size:12px;color:${ownerViewMode?'var(--orange)':'var(--text2)'};cursor:pointer;" onclick="ownerViewMode=true;fetchGames().then(()=>render())">Organizer</span>
  </div>` : '';

  return `<div class="fade-in">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
      <h2 style="font-weight:800;font-size:24px;">Upcoming Games</h2>
      <div style="display:flex;align-items:center;gap:12px;">
        ${viewToggle}
        <span style="color:var(--text2);font-size:13px;">${games.length} game${games.length!==1?'s':''}</span>
      </div>
    </div>
    <div class="games-grid">${games.map(g=>renderGameColumn(g)).join('')}</div></div>`;
}

function renderGameColumn(game) {
  const started = isGameStarted(game);
  const isSignedUp = game.signups.find(s=>s.player_id===currentUser.id);
  const cap = game.cap_enabled ? game.cap : 'âˆ';
  const inGame = game.signups.filter(s=>s.status==='in');
  const waitlist = game.signups.filter(s=>s.status==='waitlist');
  const spotsLeft = game.cap_enabled ? Math.max(0, game.cap - inGame.length) : null;

  let actionBtn = '';
  if (!started && !game.closed) {
    if (isSignedUp) actionBtn = `<button class="btn-danger" style="width:100%;font-size:13px;padding:8px;" onclick="takeOff(${game.id})">âœ• Take Me Off</button>`;
    else actionBtn = `<button class="btn-primary" style="width:100%;font-size:13px;padding:8px;" onclick="addMe(${game.id})">+ Add Me</button>`;
  } else if (started) actionBtn = `<span style="color:var(--text2);font-size:12px;">Game started</span>`;

  let statusBadge = '';
  if (game.algorithm==='random' && !game.selection_done)
    statusBadge = `<div style="margin-top:6px;"><span class="badge badge-orange" style="animation:pulse 2s infinite;">â³ Selection pending</span></div>`; else if (spotsLeft!==null && spotsLeft>0)
    statusBadge = `<div style="margin-top:6px;"><span class="badge badge-green">${spotsLeft} spot${spotsLeft!==1?'s':''} open</span></div>`;
  else if (spotsLeft===0)
    statusBadge = `<div style="margin-top:6px;"><span class="badge badge-red">Full</span></div>`;

  let playerList = '';
  if (game.selection_done || game.algorithm==='first_come') {
    inGame.forEach((s,i)=> { playerList += `<div class="player-slot in-game"><span class="num">${i+1}</span> ${esc(s.player_name)}</div>`; });
    if (spotsLeft!==null) for(let i=0;i<spotsLeft;i++) playerList += `<div class="empty-slot"></div>`;
    if (waitlist.length>0) {
      playerList += `<div class="waitlist-divider">â€” Waitlist â€”</div>`;
      waitlist.forEach((s,i)=> { playerList += `<div class="player-slot waitlist"><span class="num">W${i+1}</span> ${esc(s.player_name)}</div>`; });
    }
  } else {
    const all = [...game.signups].sort((a,b)=>new Date(a.signed_up_at)-new Date(b.signed_up_at));
    all.forEach((s,i)=> { playerList += `<div class="player-slot pending"><span class="num">${i+1}</span> ${esc(s.player_name)}</div>`; });
  }

  const algLabel = {first_come:'First Come',random:'Random',weighted:'Weighted'}[game.algorithm]||game.algorithm;
  let ownerCtrl = '';
  const isGameOrganizer = isOrganizer() && ownerViewMode && orgGroups().some(g => g.group_id === game.group_id);
  if (isGameOrganizer && !started && !game.closed) {
    let cascadeStatus = '';
    if (game.notified_at) {
      // Build detailed cascade timeline
      let steps = [];

      // High priority
      steps.push(`<div style="display:flex;align-items:center;gap:6px;"><span style="color:var(--green);">âœ…</span> <span>High priority notified</span></div>`);

      // Standard priority
      if (game.notify_standard_status === 'completed') {
        steps.push(`<div style="display:flex;align-items:center;gap:6px;"><span style="color:var(--green);">âœ…</span> <span>Standard priority notified</span></div>`);
      } else if (game.notify_standard_at) {
        steps.push(`<div style="display:flex;align-items:center;gap:6px;"><span>â³</span> <span>Standard priority <span id="cd-std-${game.id}" data-target="${game.notify_standard_at}" class="cascade-cd"></span></span></div>`);
      }

      // Selection (random only)
      if (game.algorithm === 'random') {
        if (game.selection_done) {
          steps.push(`<div style="display:flex;align-items:center;gap:6px;"><span style="color:var(--green);">âœ…</span> <span>Players selected</span></div>`);
        } else if (game.auto_selection_at) {
          steps.push(`<div style="display:flex;align-items:center;gap:6px;"><span>ğŸ²</span> <span>Auto-select <span id="cd-sel-${game.id}" data-target="${game.auto_selection_at}" class="cascade-cd"></span></span></div>`);
        }
      }

      // Low priority
      if (game.notify_low_status === 'completed') {
        steps.push(`<div style="display:flex;align-items:center;gap:6px;"><span style="color:var(--green);">âœ…</span> <span>Low priority notified</span></div>`);
      } else if (game.notify_low_at) {
        steps.push(`<div style="display:flex;align-items:center;gap:6px;"><span>â³</span> <span>Low priority <span id="cd-low-${game.id}" data-target="${game.notify_low_at}" class="cascade-cd"></span></span></div>`);
      }

      if (steps.length > 0) {
        cascadeStatus = `<div style="padding:4px 16px 8px;font-size:11px;color:var(--text2);display:grid;gap:3px;">${steps.join('')}</div>`;
      }
    }

    ownerCtrl = `${cascadeStatus}<div style="padding:4px 16px 8px;display:flex;gap:4px;">
      ${game.algorithm==='random'&&!game.selection_done ? `<button class="btn-primary btn-sm" style="flex:1;font-size:11px;" onclick="runSelection(${game.id})">âš¡ Set Now</button>` : ''}
      <button class="btn-danger btn-sm" style="font-size:11px;" onclick="cancelGame(${game.id})">Cancel</button></div>`;
  }

  // Find location address from cachedLocations
  const locObj = cachedLocations.find(l => l.name === game.location);
  const locAddr = locObj && locObj.address ? locObj.address : '';
  const locDisplay = locAddr
    ? `<span style="cursor:pointer;text-decoration:underline dotted;position:relative;" title="${esc(locAddr)}" onclick="alert('ğŸ“ ${esc(locAddr)}')">${esc(game.location)}</span>`
    : esc(game.location);

  // Edit button for organizers
  let editBtn = '';
  if (isGameOrganizer && !game.closed && !started) {
    editBtn = `<button class="btn-secondary btn-sm" style="font-size:11px;" onclick="showEditGame(${game.id})">âœï¸ Edit</button>`;
  }

  return `<div class="game-col slide-in">
    <div class="game-header">
      <div class="weekday">${formatWeekday(game.date)}</div>
      <div class="date">${formatDate(game.date)}</div>
      <div class="time-loc">${formatTime(game.date)} Â· ${locDisplay}</div>
      <div class="cap">Max: ${cap} Â· ${algLabel}</div>${statusBadge}
      ${game.group_name ? `<div style="margin-top:4px;"><span class="badge badge-blue">${esc(game.group_name)}</span></div>` : ''}
    </div>
    <div class="game-action">${actionBtn}</div>${ownerCtrl}
    ${editBtn ? `<div style="padding:0 16px 8px;">${editBtn}</div>` : ''}
    <div class="game-players">${playerList || '<div style="text-align:center;padding:20px;color:var(--text2);font-size:13px;">No signups yet</div>'}</div>
  </div>`;
}

// â•â•â• GAME ACTIONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function addMe(gameId) {
  try {
    await api(`/games/${gameId}/signup`, {method:'POST'});
    showToast('Signed up!', 'success');
    await fetchGames(); render();
  } catch(e) { showToast(e.message,'error'); }
}

async function takeOff(gameId) {
  try {
    await api(`/games/${gameId}/signup`, {method:'DELETE'});
    showToast('Removed','success');
    await fetchGames(); render();
  } catch(e) { showToast(e.message,'error'); }
}

async function runSelection(gameId) {
  try {
    const r = await api(`/games/${gameId}/run-selection`, {method:'POST'});
    showToast(`Selection done: ${r.in_count} in, ${r.waitlist_count} waitlisted`,'success');
    await fetchGames(); render();
  } catch(e) { showToast(e.message,'error'); }
}

async function cancelGame(gameId) {
  const game = cachedGames.find(g => g.id === gameId);
  const signupCount = game ? game.signups.length : 0;
  const msg = signupCount > 0
    ? `Cancel this game? ${signupCount} signed-up player${signupCount!==1?'s':''} will be notified.`
    : 'Cancel this game?';
  if (!confirm(msg)) return;
  try { await api(`/games/${gameId}/close`, {method:'POST'}); showToast('Game cancelled â€” players notified','success'); await fetchGames(); render(); }
  catch(e) { showToast(e.message,'error'); }
}

function showEditGame(gameId) {
  const game = cachedGames.find(g => g.id === gameId);
  if (!game) return;
  const pad = n => String(n).padStart(2,'0');
  const d = new Date(game.date);
  const dtVal = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  const locOptions = cachedLocations.map(l=>{
    const sel = l.name === game.location ? 'selected' : '';
    return `<option value="${esc(l.name)}" ${sel}>${esc(l.name)}</option>`;
  }).join('') + `<option value="other">Other...</option>`;

  const html = `<div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px;" id="edit-game-modal" onclick="if(event.target===this)this.remove()">
    <div class="card" style="max-width:400px;width:100%;"><h3 style="font-size:16px;font-weight:700;margin-bottom:16px;">Edit Game</h3>
    <div style="display:grid;gap:12px;">
      <div><label>Date &amp; Time</label><input type="datetime-local" id="eg-datetime" value="${dtVal}"></div>
      <div><label>Location</label><select id="eg-location">${locOptions}</select></div>
      <div style="display:flex;gap:8px;">
        <button class="btn-primary" style="flex:1;" onclick="editGame(${gameId})">Save Changes</button>
        <button class="btn-secondary" onclick="document.getElementById('edit-game-modal').remove()">Cancel</button>
      </div>
    </div></div></div>`;
  document.body.insertAdjacentHTML('beforeend', html);
}

async function editGame(gameId) {
  const dt = document.getElementById('eg-datetime').value;
  const gameDate = dt.length === 16 ? dt + ':00' : dt;
  const location = document.getElementById('eg-location').value;
  const body = {};
  const game = cachedGames.find(g => g.id === gameId);
  if (gameDate && gameDate !== game.date) body.date = gameDate;
  if (location && location !== 'other' && location !== game.location) body.location = location;
  if (!Object.keys(body).length) { showToast('No changes made','info'); return; }
  try {
    await api(`/games/${gameId}`, {method:'PATCH', body:JSON.stringify(body)});
    showToast('Game updated â€” players notified','success');
    document.getElementById('edit-game-modal')?.remove();
    await fetchGames(); render();
  } catch(e) { showToast(e.message,'error'); }
}

// â•â•â• CREATE GAME â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCreateGame() {
  if (!isOrganizer()) return '<p>Access denied.</p>';
  const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate()+1);
  tomorrow.setHours(18,0,0,0);
  const pad = n => String(n).padStart(2,'0');
  const defaultDT = `${tomorrow.getFullYear()}-${pad(tomorrow.getMonth()+1)}-${pad(tomorrow.getDate())}T${pad(tomorrow.getHours())}:${pad(tomorrow.getMinutes())}`;
  const defaultNotifyDT = `${tomorrow.getFullYear()}-${pad(tomorrow.getMonth()+1)}-${pad(tomorrow.getDate())}T12:00`;
  const defAlg = cachedSettings?.default_algorithm || 'first_come';
  const defLoc = cachedSettings?.default_location || '';
  const defCap = cachedSettings?.default_cap || 12;
  const defCapOn = cachedSettings?.cap_enabled !== false;

  const locOptions = cachedLocations.map(l=>{
    const sel = l.name === defLoc ? 'selected' : '';
    return `<option value="${esc(l.name)}" ${sel}>${esc(l.name)}</option>`;
  }).join('');

  const approvedPlayers = cachedPlayers.filter(p=>p.status==='active');
  const sorted = sortPlayers(approvedPlayers, cgPlayerSort);
  const playerCheckboxes = sorted.map(p=>{
    const prioLabel = p.priority !== 'standard' ? ` <span style="font-size:11px;opacity:0.5;">(${p.priority})</span>` : '';
    return `<label style="display:flex;align-items:center;gap:8px;padding:6px 0;cursor:pointer;"><input type="checkbox" class="owner-add-player" value="${p.player_id}" style="width:auto;"> ${esc(p.name)}${prioLabel}</label>`;
  }).join('');

  // Group selector for multi-group organizers
  const og = orgGroups();
  const gid = activeOrgGroupId();
  let groupSelector = '';
  if (og.length > 1) {
    const gOpts = og.map(g => `<option value="${g.group_id}" ${g.group_id===gid?'selected':''}>${esc(g.group_name)}</option>`).join('');
    groupSelector = `<div><label>Group</label><select id="cg-group">${gOpts}</select></div>`;
  }

  return `<div class="fade-in" style="max-width:600px;">
    <h2 style="font-weight:800;font-size:24px;margin-bottom:20px;">Create Game</h2>
    <div class="card"><div style="display:grid;gap:16px;">
      ${groupSelector}
      <div id="cg-game-slots">
        <div class="cg-slot" data-index="0">
          <div><label>Game Date &amp; Time</label><input type="datetime-local" class="cg-datetime" value="${defaultDT}"></div>
          <div style="margin-top:12px;"><label>Location</label><select class="cg-location" onchange="toggleOtherLoc(this)">${locOptions}<option value="other">Other...</option></select>
            <input type="text" class="cg-other-loc" placeholder="Enter location" style="display:none;margin-top:8px;"></div>
        </div>
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn-secondary btn-sm" onclick="addGameSlot()">+ Add Another Game</button>
        <span id="cg-slot-count" style="font-size:13px;color:var(--text2);align-self:center;"></span>
      </div>
      <div><label>Algorithm <span style="cursor:pointer;color:var(--orange);font-size:16px;vertical-align:middle;" onclick="navigate('algorithm_info')" title="Learn about algorithms">â„¹ï¸</span></label><select id="cg-algorithm" onchange="toggleRandomOpts()">
        <option value="first_come" ${defAlg==='first_come'?'selected':''}>First Come, First Served</option>
        <option value="random" ${defAlg==='random'?'selected':''}>Random Selection</option></select></div>
      <div id="cg-random-opts" style="display:${defAlg==='random'?'block':'none'};padding:8px 14px;background:var(--surface2);border-radius:8px;">
        <div style="display:flex;align-items:center;gap:12px;">
          <label class="toggle" style="margin-bottom:0;"><input type="checkbox" id="cg-high-auto" checked><span class="slider"></span></label>
          <div><span style="font-size:14px;">Auto-add high priority players</span>
            <div style="font-size:11px;color:var(--text2);margin-top:2px;">When on, high priority players are automatically signed up and guaranteed a spot. When off, they're just notified first.</div></div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:12px;">
        <label class="toggle" style="margin-bottom:0;"><input type="checkbox" id="cg-cap-on" ${defCapOn?'checked':''} onchange="toggleCapInput()"><span class="slider"></span></label>
        <span style="font-size:14px;">Player Cap</span>
        <input type="number" id="cg-cap" value="${defCap}" min="2" max="100" style="width:80px;${defCapOn?'':'opacity:0.4'}"></div>
      <div><label>Add Players to Game</label>
        <div style="display:flex;gap:8px;margin-bottom:8px;">
          <span style="font-size:13px;color:var(--text2);">Sort:</span>
          <button class="btn-secondary btn-sm ${cgPlayerSort==='priority'?'active':''}" onclick="cgPlayerSort='priority';render()">Priority</button>
          <button class="btn-secondary btn-sm ${cgPlayerSort==='first'?'active':''}" onclick="cgPlayerSort='first';render()">First Name</button>
          <button class="btn-secondary btn-sm ${cgPlayerSort==='last'?'active':''}" onclick="cgPlayerSort='last';render()">Last Name</button>
        </div>
        <div class="card" style="max-height:200px;overflow-y:auto;padding:8px 14px;">${playerCheckboxes||'<span style="color:var(--text2);font-size:13px;">No players loaded</span>'}</div></div>
      <div style="display:flex;align-items:center;gap:12px;">
        <label class="toggle" style="margin-bottom:0;"><input type="checkbox" id="cg-delay-notif"><span class="slider"></span></label>
        <span style="font-size:14px;">Notify at future time</span></div>
      <div id="cg-delay-fields" style="display:none;">
        <label>Notification Date &amp; Time</label><input type="datetime-local" id="cg-notify-datetime" value="${defaultNotifyDT}"></div>
      <button class="btn-primary" id="cg-btn" style="width:100%;padding:12px;margin-top:8px;" onclick="createGame()">Create Game</button>
    </div></div></div>`;
}

function addGameSlot() {
  const slots = document.getElementById('cg-game-slots');
  const count = slots.querySelectorAll('.cg-slot').length;
  if (count >= 10) { showToast('Max 10 games per batch','error'); return; }
  const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate()+2+count);
  tomorrow.setHours(18,0,0,0);
  const pad = n => String(n).padStart(2,'0');
  const dt = `${tomorrow.getFullYear()}-${pad(tomorrow.getMonth()+1)}-${pad(tomorrow.getDate())}T${pad(tomorrow.getHours())}:${pad(tomorrow.getMinutes())}`;
  const defLoc = cachedSettings?.default_location || '';
  const locOptions = cachedLocations.map(l=>{
    const sel = l.name === defLoc ? 'selected' : '';
    return `<option value="${esc(l.name)}" ${sel}>${esc(l.name)}</option>`;
  }).join('');
  const div = document.createElement('div');
  div.className = 'cg-slot';
  div.dataset.index = count;
  div.innerHTML = `<hr style="border:none;border-top:1px solid var(--border);margin:16px 0;">
    <div style="display:flex;justify-content:space-between;align-items:center;"><strong style="font-size:14px;">Game ${count+1}</strong>
      <button class="btn-danger btn-sm" onclick="this.closest('.cg-slot').remove();updateSlotCount()">Remove</button></div>
    <div style="margin-top:8px;"><label>Game Date &amp; Time</label><input type="datetime-local" class="cg-datetime" value="${dt}"></div>
    <div style="margin-top:12px;"><label>Location</label><select class="cg-location" onchange="toggleOtherLoc(this)">${locOptions}<option value="other">Other...</option></select>
      <input type="text" class="cg-other-loc" placeholder="Enter location" style="display:none;margin-top:8px;"></div>`;
  slots.appendChild(div);
  updateSlotCount();
}
function updateSlotCount() {
  const n = document.querySelectorAll('.cg-slot').length;
  const el = document.getElementById('cg-slot-count');
  if (el) el.textContent = n > 1 ? `${n} games` : '';
}

function toggleOtherLoc(el) {
  const parent = el ? el.closest('.cg-slot') || el.closest('.card') : document;
  const otherInput = parent.querySelector('.cg-other-loc');
  if (otherInput) otherInput.style.display = el.value === 'other' ? 'block' : 'none';
}
function toggleCapInput() { const on=document.getElementById('cg-cap-on').checked; document.getElementById('cg-cap').style.opacity=on?'1':'0.4'; }
function toggleRandomOpts() {
  const alg = document.getElementById('cg-algorithm').value;
  const opts = document.getElementById('cg-random-opts');
  if (opts) opts.style.display = alg === 'random' ? 'block' : 'none';
}

async function createGame() {
  const slots = document.querySelectorAll('.cg-slot');
  const algorithm = document.getElementById('cg-algorithm').value;
  const capEnabled = document.getElementById('cg-cap-on').checked;
  const cap = parseInt(document.getElementById('cg-cap').value)||12;
  const highAutoEl = document.getElementById('cg-high-auto');
  const randomHighAuto = highAutoEl ? highAutoEl.checked : true;
  const ownerAdded = [...document.querySelectorAll('.owner-add-player:checked')].map(cb=>parseInt(cb.value)).filter(n=>!isNaN(n));
  const groupEl = document.getElementById('cg-group');
  const groupId = groupEl ? parseInt(groupEl.value) : activeOrgGroupId();
  let notify_future_at = null;
  if (document.getElementById('cg-delay-notif').checked) {
    const ndt = document.getElementById('cg-notify-datetime').value;
    if(ndt) notify_future_at = ndt.length === 16 ? ndt + ':00' : ndt;
  }

  // Collect games from all slots
  const games = [];
  for (const slot of slots) {
    const dt = slot.querySelector('.cg-datetime').value;
    if(!dt) { showToast('Set a date and time for all games','error'); return; }
    const gameDate = dt.length === 16 ? dt + ':00' : dt;
    if (isNaN(new Date(gameDate).getTime())) { showToast('Invalid date/time','error'); return; }
    let location = slot.querySelector('.cg-location').value;
    if(location==='other') location = slot.querySelector('.cg-other-loc').value || 'TBD';
    games.push({ group_id:groupId, date:gameDate, location, algorithm, cap, cap_enabled:capEnabled, owner_added_player_ids:ownerAdded, notify_future_at, random_high_auto:randomHighAuto });
  }

  const btn=document.getElementById('cg-btn'); btn.disabled=true; btn.innerHTML='<span class="spinner"></span>';
  try {
    if (games.length === 1) {
      await api('/games', { method:'POST', body:JSON.stringify(games[0]) });
    } else {
      await api('/games/batch', { method:'POST', body:JSON.stringify({games}) });
    }
    showToast(`${games.length} game${games.length>1?'s':''} created! ğŸ‰`,'success');
    await fetchGames(); navigate('games');
  } catch(e) { showToast(e.message,'error'); btn.disabled=false; btn.textContent='Create Game'; }
}

// â•â•â• PLAYER SETTINGS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPlayerSettings() {
  const u = currentUser;
  const groups = myGroups();
  const invs = pendingInvitations();
  const groupRows = groups.map(g => {
    const roleBadge = g.role==='organizer' ? `<span class="badge badge-green" style="margin-left:6px;">Organizer</span>` : '';
    return `<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);">
      <div><strong>${esc(g.group_name)}</strong>${roleBadge}</div>
      <button class="btn-danger btn-sm" onclick="leaveGroup(${g.group_id},'${esc(g.group_name).replace(/'/g,"\\'")}')">Leave</button>
    </div>`;
  }).join('');
  const invRows = invs.map(inv => `<div class="invitation-card" style="margin-bottom:8px;">
    <div><div style="font-weight:600;">${esc(inv.group_name)}</div>
    <div style="font-size:12px;color:var(--text2);">From ${esc(inv.invited_by_name)}</div></div>
    <div style="display:flex;gap:4px;">
      <button class="btn-primary btn-sm" onclick="respondInvitation('${inv.token}','accept')">Accept</button>
      <button class="btn-danger btn-sm" onclick="respondInvitation('${inv.token}','decline')">Decline</button>
    </div></div>`).join('');
  return `<div class="fade-in" style="max-width:500px;">
    <h2 style="font-weight:800;font-size:24px;margin-bottom:20px;">My Settings</h2>
    <div class="card" style="margin-bottom:16px;"><h3 style="font-size:16px;font-weight:700;margin-bottom:16px;">Profile</h3>
    <div style="display:grid;gap:16px;">
      <div><label>Name</label><input id="ps-name" value="${esc(u.name)}"></div>
      <div><label>Email</label><input type="email" id="ps-email" value="${esc(u.email)}"></div>
      <div><label>Mobile</label><input type="tel" id="ps-mobile" value="${esc(u.mobile||'')}"></div>
      <div><label>New Password (leave blank to keep current)</label><input type="password" id="ps-pass" placeholder="\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022"></div>
      <div><label>Notification Preference</label>
        <div style="display:flex;gap:16px;flex-wrap:wrap;padding:4px 0;">
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:14px;"><input type="checkbox" class="ps-notif-ch" value="email" ${u.notif_pref&&u.notif_pref.includes('email')?'checked':''} style="width:auto;" onchange="handleNotifCheckbox(this,'ps')"> Email</label>
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:14px;"><input type="checkbox" class="ps-notif-ch" value="sms" ${u.notif_pref&&u.notif_pref.includes('sms')?'checked':''} style="width:auto;" onchange="handleNotifCheckbox(this,'ps')"> SMS</label>
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:14px;"><input type="checkbox" class="ps-notif-none" value="none" ${u.notif_pref==='none'?'checked':''} style="width:auto;" onchange="handleNotifNone(this,'ps')"> None</label>
        </div></div>
      <button class="btn-primary" onclick="savePlayerSettings()">Save Changes</button>
    </div></div>
    ${invRows?`<div class="card" style="margin-bottom:16px;"><h3 style="font-size:16px;font-weight:700;margin-bottom:12px;">\uD83D\uDCEC Pending Invitations</h3>${invRows}</div>`:''}
    <div class="card" style="margin-bottom:16px;"><h3 style="font-size:16px;font-weight:700;margin-bottom:12px;">My Groups</h3>
      ${groupRows || '<p style="color:var(--text2);font-size:13px;">Not in any groups yet.</p>'}
      <div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border);">
        <label>Join a Group</label>
        <div style="display:flex;gap:8px;margin-bottom:12px;">
          <input id="ps-join-q" placeholder="Group name or organizer email" style="flex:1;">
          <button class="btn-primary btn-sm" onclick="joinGroupFromSettings()">Join</button>
        </div>
        <label>Create a New Group</label>
        <div style="display:flex;gap:8px;">
          <input id="ps-create-q" placeholder="New group name" style="flex:1;">
          <button class="btn-primary btn-sm" onclick="createGroupFromSettings()">Create</button>
        </div></div></div></div>`;
}

async function savePlayerSettings() {
  const body = {};
  const name=document.getElementById('ps-name').value.trim(); if(name) body.name=name;
  const email=document.getElementById('ps-email').value.trim(); if(email) body.email=email;
  const mobile=document.getElementById('ps-mobile').value.trim(); body.mobile=mobile;
  const pass=document.getElementById('ps-pass').value; if(pass) body.password=pass;
  body.notif_pref=getNotifPref('ps');
  try {
    const updated = await api('/me', {method:'PATCH', body:JSON.stringify(body)});
    currentUser = updated; setStoredUser(updated);
    showToast('Settings saved','success'); render();
  } catch(e) { showToast(e.message,'error'); }
}
async function leaveGroup(gid, name) {
  if (!confirm(`Leave "${name}"? You can rejoin later.`)) return;
  try {
    await api(`/groups/${gid}/leave`,{method:'POST'});
    showToast(`Left ${name}`,'success');
    const me = await api('/me'); currentUser=me; setStoredUser(me);
    cachedPlayers=[]; cachedSettings=null; cachedLocations=[]; await loadPageData(); render();
  } catch(e) { showToast(e.message,'error'); }
}
async function joinGroupFromSettings() {
  const q = document.getElementById('ps-join-q').value.trim();
  if (!q) { showToast('Enter a group name or organizer email','error'); return; }
  try {
    const body = q.includes('@') ? {organizer_email:q} : {group_name:q};
    await api('/groups/join',{method:'POST',body:JSON.stringify(body)});
    showToast('Group joined!','success');
    const me = await api('/me'); currentUser=me; setStoredUser(me);
    await loadPageData(); render();
  } catch(e) { showToast(e.message,'error'); }
}
async function createGroupFromSettings() {
  const q = document.getElementById('ps-create-q').value.trim();
  if (!q) { showToast('Enter a group name','error'); return; }
  try {
    await api('/groups',{method:'POST',body:JSON.stringify({name:q})});
    showToast(`Group "${q}" created! You're the organizer.`,'success');
    const me = await api('/me'); currentUser=me; setStoredUser(me);
    await loadPageData(); render();
  } catch(e) { showToast(e.message,'error'); }
}

// â•â•â• OWNER SETTINGS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderOwnerSettings() {
  if(!isOrganizer()) return '<p>Access denied.</p>';
  const s = cachedSettings;
  if(!s) return renderSpinner();
  const locs = s.locations || [];
  const locOptions = locs.map(l=>{
    const sel = l.name === s.default_location ? 'selected' : '';
    return `<option value="${esc(l.name)}" ${sel}>${esc(l.name)}</option>`;
  }).join('');
  const locList = locs.map((l,i)=>
    `<div style="display:flex;align-items:center;gap:8px;padding:10px 0;border-bottom:1px solid var(--border);" data-loc-id="${l.id}">
      <div style="display:flex;flex-direction:column;gap:2px;">
        <button class="btn-secondary btn-sm" style="padding:2px 6px;font-size:10px;line-height:1;" onclick="moveLocation(${l.id},'up')" ${i===0?'disabled':''}>â–²</button>
        <button class="btn-secondary btn-sm" style="padding:2px 6px;font-size:10px;line-height:1;" onclick="moveLocation(${l.id},'down')" ${i===locs.length-1?'disabled':''}>â–¼</button>
      </div>
      <div style="flex:1;min-width:0;">
        <div style="font-size:14px;font-weight:500;">${esc(l.name)}</div>
        ${l.address?`<div style="font-size:12px;color:var(--text2);margin-top:2px;">${esc(l.address)}</div>`:''}
      </div>
      <button class="btn-secondary btn-sm" onclick="showEditLocation(${l.id},'${esc(l.name).replace(/'/g,"\\'")}','${esc(l.address||'').replace(/'/g,"\\'")}')">âœï¸</button>
      <button class="btn-danger btn-sm" onclick="removeLocation(${l.id})">âœ•</button>
    </div>`
  ).join('');
  return `<div class="fade-in" style="max-width:600px;">
    <h2 style="font-weight:800;font-size:24px;margin-bottom:20px;">Organizer Settings</h2>
    ${renderGroupSelector()}
    <div class="card" style="margin-bottom:16px;"><h3 style="font-size:16px;font-weight:700;margin-bottom:16px;">Game Defaults</h3>
      <div style="display:grid;gap:16px;">
        <div><label>Default Algorithm</label><select id="os-alg">
          <option value="first_come" ${s.default_algorithm==='first_come'?'selected':''}>First Come</option>
          <option value="random" ${s.default_algorithm==='random'?'selected':''}>Random</option></select></div>
        <div><label>Default Location</label><select id="os-def-loc">
          <option value="">â€” None â€”</option>${locOptions}</select></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div><label>Default Cap</label><input type="number" id="os-cap" value="${s.default_cap}" min="2" max="100"></div>
          <div style="display:flex;align-items:end;gap:8px;padding-bottom:2px;">
            <label class="toggle" style="margin-bottom:0;"><input type="checkbox" id="os-cap-on" ${s.cap_enabled?'checked':''}><span class="slider"></span></label>
            <span style="font-size:13px;">Cap enabled</span></div></div>
      </div></div>
    <div class="card" style="margin-bottom:16px;"><h3 style="font-size:16px;font-weight:700;margin-bottom:16px;">Notification Delays</h3>
      <div style="display:grid;gap:16px;">
        <div><label>High Priority â†’ Standard Delay (minutes)</label><input type="number" id="os-hp-delay" value="${s.high_priority_delay_minutes}" min="0"></div>
        <div><label>Standard â†’ Alternative Delay (minutes)</label><input type="number" id="os-alt-delay" value="${s.alternative_delay_minutes}" min="0"></div>
        <div><label>Random Wait Period (minutes)</label><input type="number" id="os-rand-wait" value="${s.random_wait_period_minutes}" min="0"></div>
        <div style="display:flex;align-items:center;gap:8px;">
          <label class="toggle" style="margin-bottom:0;"><input type="checkbox" id="os-notify-new" ${s.notify_owner_new_signup?'checked':''}><span class="slider"></span></label>
          <span style="font-size:13px;">Notify organizers of new player signups</span></div>
        <button class="btn-primary" onclick="saveOwnerSettings()">Save Settings</button>
      </div></div>
    <div class="card"><h3 style="font-size:16px;font-weight:700;margin-bottom:16px;">Locations</h3>${locList||'<p style="color:var(--text2);font-size:13px;">No locations yet.</p>'}
      <div style="display:grid;gap:8px;margin-top:16px;padding-top:12px;border-top:1px solid var(--border);">
        <div style="display:flex;gap:8px;">
          <input id="os-new-loc" placeholder="Location name" style="flex:1;">
        </div>
        <input id="os-new-addr" placeholder="Address (optional)" style="flex:1;">
        <button class="btn-primary btn-sm" onclick="addLocation()">+ Add Location</button>
      </div></div></div>`;
}

async function saveOwnerSettings() {
  const gid = activeOrgGroupId();
  try {
    await api(`/groups/${gid}/settings`, { method:'PATCH', body:JSON.stringify({
      default_algorithm: document.getElementById('os-alg').value,
      default_location: document.getElementById('os-def-loc').value,
      default_cap: parseInt(document.getElementById('os-cap').value),
      cap_enabled: document.getElementById('os-cap-on').checked,
      high_priority_delay_minutes: parseInt(document.getElementById('os-hp-delay').value),
      alternative_delay_minutes: parseInt(document.getElementById('os-alt-delay').value),
      random_wait_period_minutes: parseInt(document.getElementById('os-rand-wait').value),
      notify_owner_new_signup: document.getElementById('os-notify-new').checked,
    })});
    showToast('Settings saved','success'); await fetchSettings(); render();
  } catch(e) { showToast(e.message,'error'); }
}

async function addLocation() {
  const gid = activeOrgGroupId();
  const name = document.getElementById('os-new-loc').value.trim();
  const address = document.getElementById('os-new-addr').value.trim();
  if(!name) { showToast('Enter a location name','error'); return; }
  try { await api(`/groups/${gid}/locations`,{method:'POST',body:JSON.stringify({name,address})}); showToast('Location added','success'); await fetchSettings(); render(); }
  catch(e) { showToast(e.message,'error'); }
}

async function removeLocation(locId) {
  const gid = activeOrgGroupId();
  if(!confirm('Remove this location?')) return;
  try { await api(`/groups/${gid}/locations/${locId}`,{method:'DELETE'}); showToast('Location removed','success'); await fetchSettings(); render(); }
  catch(e) { showToast(e.message,'error'); }
}

function showEditLocation(locId, name, address) {
  const html = `<div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px;" id="edit-loc-modal" onclick="if(event.target===this)this.remove()">
    <div class="card" style="max-width:400px;width:100%;"><h3 style="font-size:16px;font-weight:700;margin-bottom:16px;">Edit Location</h3>
    <div style="display:grid;gap:12px;">
      <div><label>Name</label><input type="text" id="el-name" value="${name}"></div>
      <div><label>Address</label><input type="text" id="el-addr" value="${address}"></div>
      <div style="display:flex;gap:8px;">
        <button class="btn-primary" style="flex:1;" onclick="saveEditLocation(${locId})">Save</button>
        <button class="btn-secondary" onclick="document.getElementById('edit-loc-modal').remove()">Cancel</button>
      </div>
    </div></div></div>`;
  document.body.insertAdjacentHTML('beforeend', html);
}

async function saveEditLocation(locId) {
  const gid = activeOrgGroupId();
  const name = document.getElementById('el-name').value.trim();
  const address = document.getElementById('el-addr').value.trim();
  if(!name) { showToast('Name is required','error'); return; }
  try {
    await api(`/groups/${gid}/locations/${locId}`,{method:'PATCH',body:JSON.stringify({name,address})});
    showToast('Location updated','success');
    document.getElementById('edit-loc-modal')?.remove();
    await fetchSettings(); render();
  } catch(e) { showToast(e.message,'error'); }
}

async function moveLocation(locId, direction) {
  const gid = activeOrgGroupId();
  const locs = cachedSettings?.locations || [];
  const ids = locs.map(l=>l.id);
  const idx = ids.indexOf(locId);
  if(idx<0) return;
  if(direction==='up' && idx>0) { [ids[idx-1],ids[idx]]=[ids[idx],ids[idx-1]]; }
  else if(direction==='down' && idx<ids.length-1) { [ids[idx+1],ids[idx]]=[ids[idx],ids[idx+1]]; }
  else return;
  try {
    await api(`/groups/${gid}/locations/reorder`,{method:'POST',body:JSON.stringify({location_ids:ids})});
    await fetchSettings(); render();
  } catch(e) { showToast(e.message,'error'); }
}

// â•â•â• PLAYER MANAGEMENT (group-scoped) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPlayerMgmt() {
  if(!isOrganizer()) return '<p>Access denied.</p>';
  const gid = activeOrgGroupId();
  const invited = cachedPlayers.filter(p=>p.status==='invited');
  const active = cachedPlayers.filter(p=>p.status==='active');
  if (mgmtTab === 'invited' && invited.length === 0) mgmtTab = 'roster';
  return `<div class="fade-in">
    <h2 style="font-weight:800;font-size:24px;margin-bottom:20px;">Player Management</h2>
    ${renderGroupSelector()}
    ${invited.length>0?`<div class="alert-bar"><span style="font-size:18px;">\uD83D\uDCEC</span><span><strong>${invited.length}</strong> player${invited.length!==1?'s':''} with pending invitations</span></div>`:''}
    <div class="tabs">
      <div class="tab ${mgmtTab==='invited'?'active':''}" onclick="mgmtTab='invited';render()">Invited${invited.length?` (${invited.length})`:''}</div>
      <div class="tab ${mgmtTab==='roster'?'active':''}" onclick="mgmtTab='roster';render()">Roster (${active.length})</div>
      <div class="tab ${mgmtTab==='add'?'active':''}" onclick="mgmtTab='add';render()">Add Player</div>
    </div>
    ${mgmtTab==='invited'?renderInvitedPlayers(invited):''}
    ${mgmtTab==='roster'?renderRoster(active):''}
    ${mgmtTab==='add'?renderAddPlayer():''}
  </div>`;
}

function renderInvitedPlayers(invited) {
  if(!invited.length) return `<div class="card" style="text-align:center;padding:40px;"><p style="color:var(--text2);">No pending invitations</p></div>`;
  const rows = invited.map(p=>`<tr>
    <td><strong>${esc(p.name)}</strong></td><td>${esc(p.email)}</td><td>${esc(p.mobile)||'\u2014'}</td>
    <td><span class="badge badge-orange">Invited</span></td>
    <td><button class="btn-danger btn-sm" onclick="removeGroupMember(${p.player_id})">Remove</button></td></tr>`).join('');
  return `<div class="card" style="overflow-x:auto;"><table class="data-table"><thead><tr><th>Name</th><th>Email</th><th>Mobile</th><th>Status</th><th>Actions</th></tr></thead><tbody>${rows}</tbody></table></div>`;
}

function renderPendingPlayers(pending) {
  if(!pending.length) return `<div class="card" style="text-align:center;padding:40px;"><p style="color:var(--text2);">No pending</p></div>`;
  return renderInvitedPlayers(pending);
}

function sortPlayers(list, sortBy) {
  const prioOrder = {high:0, standard:1, low:2};
  return [...list].sort((a,b) => {
    if (sortBy === 'priority') {
      const pd = (prioOrder[a.priority]||1) - (prioOrder[b.priority]||1);
      if (pd !== 0) return pd;
      return a.name.localeCompare(b.name);
    } else if (sortBy === 'first') {
      return a.name.localeCompare(b.name);
    } else if (sortBy === 'last') {
      const aLast = a.name.split(' ').slice(-1)[0] || a.name;
      const bLast = b.name.split(' ').slice(-1)[0] || b.name;
      return aLast.localeCompare(bLast);
    }
    return 0;
  });
}

function renderRoster(approved) {
  const sorted = sortPlayers(approved, rosterSort);
  const rows = sorted.map(p=>{
    const roleBadge = p.role==='organizer'?`<span class="badge badge-green">Organizer</span>`:'';
    const roleBtn = p.player_id!==currentUser.id ? (p.role==='organizer'
      ? `<button class="btn-secondary btn-sm" onclick="setMemberRole(${p.player_id},'player')">Demote</button>`
      : `<button class="btn-secondary btn-sm" onclick="setMemberRole(${p.player_id},'organizer')">Make Organizer</button>`) : '';
    return `<tr>
      <td><strong>${esc(p.name)}</strong> ${roleBadge}</td><td>${esc(p.email)}</td><td>${esc(p.mobile)||'\u2014'}</td>
      <td><select style="width:auto;padding:4px 8px;font-size:12px;" onchange="setMemberPriority(${p.player_id},this.value)">
        <option value="high" ${p.priority==='high'?'selected':''}>High</option>
        <option value="standard" ${p.priority==='standard'?'selected':''}>Standard</option>
        <option value="low" ${p.priority==='low'?'selected':''}>Low</option></select></td>
      <td><div style="display:flex;gap:4px;flex-wrap:wrap;">
        ${roleBtn}
        ${p.player_id!==currentUser.id?`<button class="btn-danger btn-sm" onclick="removeGroupMember(${p.player_id})">Remove</button>`:''}</div></td></tr>`;
  }).join('');
  return `<div style="display:flex;gap:8px;align-items:center;margin-bottom:12px;">
    <span style="font-size:13px;color:var(--text2);">Sort:</span>
    <button class="btn-secondary btn-sm ${rosterSort==='priority'?'active':''}" onclick="rosterSort='priority';render()">Priority</button>
    <button class="btn-secondary btn-sm ${rosterSort==='first'?'active':''}" onclick="rosterSort='first';render()">First Name</button>
    <button class="btn-secondary btn-sm ${rosterSort==='last'?'active':''}" onclick="rosterSort='last';render()">Last Name</button>
  </div>
  <div class="card" style="overflow-x:auto;"><table class="data-table"><thead><tr><th>Name</th><th>Email</th><th>Mobile</th><th>Priority</th><th>Actions</th></tr></thead><tbody>${rows}</tbody></table></div>`;
}

function renderAddPlayer() {
  return `<div class="card" style="max-width:400px;">
    <h3 style="font-size:16px;font-weight:700;margin-bottom:16px;">Add / Invite Player</h3>
    <p style="font-size:12px;color:var(--text2);margin-bottom:12px;">New players are auto-added to the group. Existing players receive an invitation they must accept.</p>
    <div style="display:grid;gap:12px;">
      <div><label>Name</label><input id="ap-name" placeholder="Full name"></div>
      <div><label>Email</label><input type="email" id="ap-email" placeholder="email@example.com"></div>
      <div><label>Mobile</label><input type="tel" id="ap-mobile" placeholder="555-0123"></div>
      <button class="btn-primary" onclick="invitePlayer()">Add / Invite Player</button>
    </div>
    <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--border);">
      <h3 style="font-size:16px;font-weight:700;margin-bottom:12px;">Import CSV</h3>
      <p style="font-size:13px;color:var(--text2);margin-bottom:12px;">CSV: name, email, mobile (one per line). New players auto-added; existing players get invitations.</p>
      <textarea id="csv-import" rows="4" placeholder="John Doe,john@email.com,555-0123"></textarea>
      <button class="btn-secondary" style="margin-top:8px;width:100%;" onclick="importCSV()">Import Players</button>
    </div></div>`;
}

async function setMemberPriority(pid, priority) {
  const gid = activeOrgGroupId();
  try { await api(`/groups/${gid}/members/${pid}`,{method:'PATCH',body:JSON.stringify({priority})}); showToast('Priority updated','success'); await fetchPlayers(); render(); }
  catch(e) { showToast(e.message,'error'); }
}
async function setMemberRole(pid, role) {
  const gid = activeOrgGroupId();
  const action = role==='organizer' ? 'Make this player an organizer?' : 'Remove organizer access?';
  if(!confirm(action)) return;
  try {
    await api(`/groups/${gid}/members/${pid}`,{method:'PATCH',body:JSON.stringify({role})});
    showToast(role==='organizer'?'Now an organizer':'Organizer access removed','success');
    const me = await api('/me'); currentUser=me; setStoredUser(me);
    await fetchPlayers(); render();
  } catch(e) { showToast(e.message,'error'); }
}
async function removeGroupMember(pid) {
  const gid = activeOrgGroupId();
  if(!confirm('Remove this player from the group?')) return;
  try { await api(`/groups/${gid}/members/${pid}`,{method:'DELETE'}); showToast('Player removed','success'); await fetchPlayers(); render(); }
  catch(e) { showToast(e.message,'error'); }
}
async function invitePlayer() {
  const gid = activeOrgGroupId();
  const name=document.getElementById('ap-name').value.trim(), email=document.getElementById('ap-email').value.trim();
  const mobile=document.getElementById('ap-mobile').value.trim();
  if(!name||!email) { showToast('Name and email required','error'); return; }
  try {
    const r = await api(`/groups/${gid}/invite`,{method:'POST',body:JSON.stringify({name,email,mobile})});
    showToast(r.message,'success');
    showToast(r.message,'success');
    await fetchPlayers(); render();
  } catch(e) { showToast(e.message,'error'); }
}
async function importCSV() {
  const gid = activeOrgGroupId();
  const text = document.getElementById('csv-import').value.trim();
  if(!text) return;
  const hasHeader = text.toLowerCase().startsWith('name');
  const csvText = hasHeader ? text : 'name,email,mobile\n' + text;
  const blob = new Blob([csvText], {type:'text/csv'});
  const formData = new FormData();
  formData.append('file', blob, 'import.csv');
  try {
    const token = getToken();
    const res = await fetch(API_BASE + `/groups/${gid}/players/import`, {
      method:'POST', headers:{'Authorization':`Bearer ${token}`}, body:formData
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.detail||'Import failed');
    let msg = [];
    if(data.added) msg.push(`${data.added} added`);
    if(data.invited) msg.push(`${data.invited} invited`);
    if(data.skipped) msg.push(`${data.skipped} skipped`);
    showToast(msg.join(', ') || 'Import complete', 'success');
    await fetchPlayers(); render();
  } catch(e) { showToast(e.message,'error'); }
}

// â•â•â• ALGORITHM INFO â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAlgorithmInfo() {
  return `<div class="fade-in" style="max-width:700px;">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
      <button class="btn-secondary btn-sm" onclick="navigate('create_game')">â† Back</button>
      <h2 style="font-weight:800;font-size:24px;">How Algorithms Work</h2>
    </div>

    <div class="card" style="margin-bottom:16px;">
      <h3 style="font-size:18px;font-weight:700;color:var(--orange);margin-bottom:12px;">ğŸƒ First Come, First Served</h3>
      <p style="color:var(--text2);line-height:1.7;font-size:14px;">
        Players are added to the game in the order they sign up. The first players to respond get spots. Once the game is full, any additional signups are placed on a waitlist in the order they signed up.
      </p>
      <div class="card" style="margin-top:12px;background:var(--bg);padding:14px;">
        <div style="font-size:13px;font-weight:600;margin-bottom:8px;">How the notification cascade works:</div>
        <div style="font-size:13px;color:var(--text2);line-height:1.8;">
          1. <strong style="color:var(--green);">High priority</strong> players are notified first<br>
          2. After a delay, <strong style="color:var(--blue);">Standard priority</strong> players are notified<br>
          3. After another delay, <strong style="color:var(--grey);">Low priority</strong> players are notified<br>
          4. Players can sign up as soon as they're notified â€” first come, first served
        </div>
      </div>
      <p style="color:var(--text2);line-height:1.7;font-size:14px;margin-top:12px;">
        This gives high-priority players a head start, but doesn't guarantee them a spot. If they're slow, a standard-priority player who signs up quickly could take the last spot.
      </p>
    </div>

    <div class="card" style="margin-bottom:16px;">
      <h3 style="font-size:18px;font-weight:700;color:var(--orange);margin-bottom:12px;">ğŸ² Random Selection</h3>
      <p style="color:var(--text2);line-height:1.7;font-size:14px;">
        All players sign up during a waiting period. Once the waiting period ends, players are selected randomly to fill the available spots. The remaining players are placed on a waitlist in random order.
      </p>

      <div class="card" style="margin-top:12px;background:var(--bg);padding:14px;">
        <div style="font-size:13px;font-weight:600;margin-bottom:8px;">High priority â€” two modes:</div>
        <div style="font-size:13px;color:var(--text2);line-height:1.8;">
          <strong style="color:var(--green);">Auto-add (default):</strong> High priority players are automatically signed up and guaranteed a spot in the game. They don't need to take any action â€” they're in unless they choose to drop.<br><br>
          <strong style="color:var(--blue);">Notify first only:</strong> High priority players are simply notified before others. They must sign up themselves, and during selection, everyone is treated equally in the random draw â€” no guaranteed spots.
        </div>
      </div>

      <div class="card" style="margin-top:12px;background:var(--bg);padding:14px;">
        <div style="font-size:13px;font-weight:600;margin-bottom:8px;">Selection order:</div>
        <div style="font-size:13px;color:var(--text2);line-height:1.8;">
          1. <strong>Organizer-added</strong> players are always in (guaranteed)<br>
          2. If auto-add is on: <strong style="color:var(--green);">High priority</strong> players get guaranteed spots<br>
          3. Remaining spots filled by <strong>random draw</strong> from all other signups<br>
          4. Everyone else goes to the waitlist in random order
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="font-size:18px;font-weight:700;color:var(--orange);margin-bottom:12px;">âš™ï¸ Priority Tiers</h3>
      <div style="display:grid;gap:12px;">
        <div style="display:flex;align-items:start;gap:10px;">
          <span class="badge badge-green" style="margin-top:2px;">High</span>
          <span style="font-size:14px;color:var(--text2);">Core players who get first access. In random mode with auto-add, they're guaranteed a spot.</span>
        </div>
        <div style="display:flex;align-items:start;gap:10px;">
          <span class="badge badge-blue" style="margin-top:2px;">Standard</span>
          <span style="font-size:14px;color:var(--text2);">Regular players. Notified after the high-priority delay.</span>
        </div>
        <div style="display:flex;align-items:start;gap:10px;">
          <span class="badge badge-grey" style="margin-top:2px;">Low</span>
          <span style="font-size:14px;color:var(--text2);">Subs and alternates. Notified last, and only if spots remain.</span>
        </div>
      </div>
      <p style="color:var(--text2);line-height:1.7;font-size:13px;margin-top:16px;">
        Notification delays between tiers are configured in <strong>Organizer Settings</strong>. Default is 60 minutes between high and standard, 24 hours between standard and low.
      </p>
    </div>
  </div>`;
}

// â•â•â• NAVIGATION & LIFECYCLE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function navigate(page) {
  currentPage = page;
  mobileMenuOpen = false;
  render(); // Render immediately with cached data
  window.scrollTo(0,0);
  if (currentUser) {
    await loadPageData();
    render(); // Re-render with fresh data
  }
}

async function doLogout() {
  try { await api('/auth/logout',{method:'POST'}); } catch {}
  clearToken(); currentUser = null; currentPage = 'login';
  cachedGames=[]; cachedPlayers=[]; cachedSettings=null; cachedLocations=[];
  stopGameRefresh();
  render();
}

function toggleMobileMenu() { mobileMenuOpen=!mobileMenuOpen; render(); }
function closeMobileMenu(e) { if(e.target.classList.contains('mobile-menu')){ mobileMenuOpen=false; render(); } }

function bindEvents() {
  const dt = document.getElementById('cg-delay-notif');
  if(dt) { const f=document.getElementById('cg-delay-fields'); if(f) f.style.display=dt.checked?'grid':'none'; dt.onchange=()=>{ f.style.display=dt.checked?'grid':'none'; }; }
  updateCountdowns();
}

// Countdown timers for auto-selection and cascade
let countdownTimer = null;
function updateCountdowns() {
  if(countdownTimer) clearInterval(countdownTimer);
  const els = document.querySelectorAll('[data-target]');
  if(!els.length) return;
  function tick() {
    els.forEach(el => {
      const target = new Date(el.dataset.target);
      const now = new Date();
      const diff = target - now;
      if(diff <= 0) {
        el.textContent = el.classList.contains('cascade-cd') ? '(done)' : 'Auto-selecting now...';
        return;
      }
      const hrs = Math.floor(diff/3600000);
      const mins = Math.floor((diff%3600000)/60000);
      const secs = Math.floor((diff%60000)/1000);
      let timeStr;
      if(hrs > 0) timeStr = `${hrs}h ${mins}m`;
      else if(mins > 0) timeStr = `${mins}m ${secs}s`;
      else timeStr = `${secs}s`;

      if (el.classList.contains('cascade-cd')) {
        el.textContent = `in ${timeStr}`;
      } else {
        el.textContent = `â± Auto-selects in ${timeStr}`;
      }
    });
  }
  tick();
  countdownTimer = setInterval(tick, 1000);
}

// Auto-refresh games every 30s
function startGameRefresh() {
  stopGameRefresh();
  gameRefreshTimer = setInterval(async ()=>{
    if(currentPage==='games' && currentUser) {
      await fetchGames();
      render();
    }
  }, 30000);
}
function stopGameRefresh() { if(gameRefreshTimer) { clearInterval(gameRefreshTimer); gameRefreshTimer=null; } }

// â•â•â• INIT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(async function init() {
  // Check for password reset token in URL
  const params = new URLSearchParams(window.location.search);
  const resetToken = params.get('reset');
  if (resetToken) {
    currentPage = 'reset_password';
    window._resetToken = resetToken;
    render();
    return;
  }

  if (currentUser && getToken()) {
    // Validate stored session
    try {
      const me = await api('/me');
      currentUser = me; setStoredUser(me);

      if (currentUser.force_password_change) {
        currentPage = 'force_change_pw';
        render();
        return;
      }

      currentPage = 'games';
      await loadPageData();
      render();
      startGameRefresh();
      // Show invitation prompt if pending
      setTimeout(() => showInvitationPrompt(), 500);
    } catch {
      // Token invalid
      clearToken(); currentUser=null; currentPage='login'; render();
    }
  } else {
    render();
  }
})();
</script>
</body>
</html>
